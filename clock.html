<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SDIS | World Clock</title>
    <meta name="description" content="SDIS World Clock" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&family=Montserrat:wght@700;800&display=swap"
        rel="stylesheet" />

    <!-- Leaflet CSS (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Luxon (Time Management) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.3/luxon.min.js"></script>

    <style>
        :root {
            --bg-main: #000000;
            --panel-bg: #0a0a0a;
            --border: #333333;
            --text-main: #ffffff;
            --text-muted: #888888;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-discord: #5865F2;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* Panel & Layout */
        .min-panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        .min-panel:hover {
            border-color: #444;
        }

        /* Inputs & Search */
        .search-group {
            background-color: #000;
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 4px 6px;
            transition: border-color 0.2s;
        }

        .search-group:focus-within {
            border-color: #ffffff;
        }

        .search-input {
            background: transparent;
            border: none;
            color: white;
            padding: 12px;
            width: 100%;
            font-size: 14px;
            outline: none;
        }

        .search-action-btn {
            background: #ffffff;
            color: black;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 14px;
            transition: opacity 0.2s;
            white-space: nowrap;
        }

        .search-action-btn:hover {
            opacity: 0.9;
        }

        /* Buttons */
        .min-btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: #ccc;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .min-btn-outline:hover {
            border-color: #666;
            color: white;
            background: #111;
        }

        /* Digital Clock Styles */
        .digit {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            letter-spacing: -0.05em;
        }

        /* Map Styling */
        #map {
            height: 400px;
            width: 100%;
            background: #050505;
            z-index: 1;
        }

        .leaflet-container {
            background: #050505 !important;
            font-family: 'Inter', sans-serif !important;
        }

        /* Custom Popup Styling */
        .leaflet-popup-content-wrapper {
            background: #0a0a0a !important;
            color: #ffffff !important;
            border: 1px solid #333;
            border-radius: 6px !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.8) !important;
            padding: 0 !important;
            overflow: hidden;
        }

        .leaflet-popup-tip {
            background: #0a0a0a !important;
            border: 1px solid #333;
            box-shadow: none !important;
        }

        .leaflet-popup-content {
            margin: 24px 20px 20px 20px !important;
            line-height: 1.5;
            width: 200px !important;
        }

        /* Close Button Styling */
        .leaflet-container a.leaflet-popup-close-button {
            color: #888 !important;
            font-size: 16px !important;
            padding: 8px !important;
            top: 4px !important;
            right: 4px !important;
            transition: color 0.2s;
        }

        .leaflet-container a.leaflet-popup-close-button:hover {
            color: #ffffff !important;
        }

        /* Dark Map Tiles Filter */
        .leaflet-tile-pane {
            filter: brightness(0.8) contrast(1.2) saturate(0.8);
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #111;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Autocomplete Dropdown */
        .autocomplete-items {
            position: absolute;
            border: 1px solid var(--border);
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #000;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }

        .autocomplete-items div {
            padding: 12px;
            cursor: pointer;
            background-color: #000;
            border-bottom: 1px solid #222;
            color: #ccc;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .autocomplete-items div:hover {
            background-color: #111;
            color: white;
        }

        .ac-highlight {
            color: #fff;
            font-weight: bold;
        }

        .ac-meta {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            margin-left: 8px;
        }
    </style>
</head>

<body>

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 bg-black/90 border-b border-[#222] px-4 py-4 backdrop-blur-md">
        <div class="max-w-6xl mx-auto flex justify-between items-center relative">
            <a href="#" class="flex items-center gap-3">
                <img src="SDIS.svg" class="h-8 w-auto object-contain opacity-90 hover:opacity-100 transition-opacity"
                    alt="SDIS" onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden')">
                <div class="hidden text-white text-xl"><i class="fas fa-clock"></i></div>
                <div class="font-bold text-lg tracking-tight text-white">SDIS <span class="text-gray-600 font-normal">/
                        World Clock</span></div>
            </a>

            <div class="flex items-center gap-4">
                <div id="utc-clock" class="text-xs text-gray-500 font-mono hidden sm:block">UTC: Loading...</div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-10 min-h-screen">

        <!-- Header Section -->
        <div class="mb-8">
            <h1 class="text-2xl font-bold text-white mb-2">World Clock</h1>
            <p class="text-gray-500 text-sm">View local time and track timezones across the globe.</p>
        </div>

        <!-- Primary Clocks (Pinned) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">

            <!-- Local Time -->
            <div class="min-panel p-5 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fas fa-map-marker-alt text-4xl text-white"></i>
                </div>
                <div
                    class="text-[10px] font-bold text-green-500 uppercase tracking-widest mb-1 flex items-center gap-2">
                    Local Time
                </div>
                <div class="text-xs text-gray-400 font-mono mb-2" id="label-local">Detecting...</div>
                <div class="text-4xl text-white digit mb-2" id="time-local">--:--</div>
                <div class="text-xs text-gray-600 font-mono" id="date-local">Syncing...</div>
            </div>

            <!-- EST Time -->
            <div class="min-panel p-5 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fas fa-building text-4xl text-blue-500"></i>
                </div>
                <div class="text-[10px] font-bold text-blue-500 uppercase tracking-widest mb-1 flex items-center gap-2">
                    Eastern Standard
                </div>
                <div class="text-xs text-gray-400 font-mono mb-2">New York, USA</div>
                <div class="text-4xl text-white digit mb-2" id="time-est">--:--</div>
                <div class="text-xs text-gray-600 font-mono" id="date-est">Syncing...</div>
            </div>

            <!-- Netherlands Time -->
            <div class="min-panel p-5 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fas fa-globe-europe text-4xl text-orange-500"></i>
                </div>
                <div
                    class="text-[10px] font-bold text-orange-500 uppercase tracking-widest mb-1 flex items-center gap-2">
                    Netherlands
                </div>
                <div class="text-xs text-gray-400 font-mono mb-2">Amsterdam, NL</div>
                <div class="text-4xl text-white digit mb-2" id="time-nl">--:--</div>
                <div class="text-xs text-gray-600 font-mono" id="date-nl">Syncing...</div>
            </div>

        </div>

        <!-- Custom Clocks Grid -->
        <div id="custom-clocks-section" class="mb-8 hidden">
            <div class="flex items-center gap-2 mb-3">
                <h3 class="text-xs font-bold text-gray-500 uppercase">My Clocks</h3>
                <div class="h-px bg-[#333] flex-1"></div>
                <button onclick="clearAllClocks()" class="text-[10px] text-red-500 hover:underline">Clear All</button>
            </div>
            <div id="my-clocks-grid" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- Map & Add Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Map Container -->
            <div class="lg:col-span-2 min-panel p-1 relative">
                <div
                    class="absolute top-4 left-4 z-[999] bg-black/80 backdrop-blur border border-[#333] px-3 py-1 rounded text-xs text-gray-300 pointer-events-none">
                    <i class="fas fa-mouse-pointer mr-1"></i> Click map to add clock
                </div>
                <div id="map" class="rounded bg-[#050505]"></div>
            </div>

            <!-- Search / Tools -->
            <div class="space-y-4">
                <div class="min-panel p-5">
                    <h3 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
                        <i class="fas fa-search text-gray-500"></i> Add City
                    </h3>
                    <div class="relative search-group mb-4" id="autocomplete-container">
                        <div class="absolute left-3 text-gray-500"><i class="fas fa-search"></i></div>
                        <input type="text" id="city-search" class="search-input" style="padding-left: 36px;"
                            placeholder="Search global cities..." autocomplete="off">
                        <div id="search-spinner" class="hidden absolute right-3 text-white"><i
                                class="fas fa-circle-notch fa-spin text-xs"></i></div>
                    </div>
                    <div class="text-xs text-gray-500 leading-relaxed">
                        Start typing to search the global database. Click a result to add a tracking clock. Data
                        persists locally.
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const DateTime = luxon.DateTime;

        // --- Configuration ---
        const PINNED_ZONES = {
            est: 'America/New_York',
            nl: 'Europe/Amsterdam'
        };

        let map;
        let mapMarkers = [];
        let userClocks = JSON.parse(localStorage.getItem('sdis_user_clocks')) || [];

        // --- Initialization ---
        function init() {
            initMap();
            initSearch();
            renderCustomClocks();

            // Start Clock Loop
            updateTime();
            setInterval(updateTime, 1000);

            // Get Local Timezone Name
            const localZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            document.getElementById('label-local').textContent = localZone.replace(/_/g, " ");
        }

        // --- Core Time Logic ---
        function updateTime() {
            const now = DateTime.now();

            // UTC Header
            document.getElementById('utc-clock').textContent = `UTC: ${now.toUTC().toFormat('HH:mm:ss')}`;

            // Pinned Clocks
            updateClockDisplay('local', now); // Uses system default
            updateClockDisplay('est', now.setZone(PINNED_ZONES.est));
            updateClockDisplay('nl', now.setZone(PINNED_ZONES.nl));

            // Custom Clocks
            userClocks.forEach((clock, index) => {
                const clockTime = now.setZone(clock.zone);
                const elTime = document.getElementById(`c-time-${index}`);
                const elDate = document.getElementById(`c-date-${index}`);
                if (elTime) elTime.textContent = clockTime.toFormat('HH:mm');
                if (elDate) elDate.textContent = clockTime.toFormat('EEE, MMM dd');
            });
        }

        function updateClockDisplay(id, dtObj) {
            const timeEl = document.getElementById(`time-${id}`);
            const dateEl = document.getElementById(`date-${id}`);
            if (timeEl) timeEl.textContent = dtObj.toFormat('HH:mm');
            if (dateEl) dateEl.textContent = dtObj.toFormat('EEE, MMM dd, yyyy');
        }

        // --- Map Logic ---
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([20, 0], 2);

            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri',
                maxZoom: 16
            }).addTo(map);

            L.control.zoom({ position: 'topright' }).addTo(map);

            setTimeout(() => { map.invalidateSize(); }, 500);

            map.on('click', async (e) => {
                const { lat, lng } = e.latlng;
                await handleMapClick(lat, lng);
            });

            userClocks.forEach(c => addMarkerToMap(c));
        }

        async function handleMapClick(lat, lng) {
            const popup = L.popup({ className: 'custom-popup' })
                .setLatLng([lat, lng])
                .setContent('<div class="text-xs font-mono">Loading...</div>')
                .openOn(map);

            try {
                const geoResp = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
                const geoData = await geoResp.json();
                const city = geoData.city || geoData.locality || geoData.principalSubdivision || `Sector ${lat.toFixed(2)}, ${lng.toFixed(2)}`;

                const tzResp = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&timezone=auto`);
                if (!tzResp.ok) throw new Error("Signal lost");
                const tzData = await tzResp.json();
                const zone = tzData.timezone;

                popup.setContent(`
                    <div class="text-center w-full">
                        <div class="font-bold text-sm mb-1 text-white">${city}</div>
                        <div class="text-xs text-gray-400 mb-3">${zone}</div>
                        <button onclick="addClock('${city.replace(/'/g, "\\'")}', '${zone}', ${lat}, ${lng})" 
                            class="bg-black border border-white text-white text-xs px-3 py-1.5 rounded hover:bg-white hover:text-black w-full font-bold transition-colors uppercase tracking-wider">
                            Add Clock
                        </button>
                    </div>
                `);

            } catch (error) {
                console.error(error);
                popup.setContent('<div class="text-xs text-red-500 font-bold">Lookup Failed.</div>');
            }
        }

        function addMarkerToMap(clock) {
            if (!clock.lat || !clock.lng) return;
            const marker = L.circleMarker([clock.lat, clock.lng], {
                color: '#ef4444',
                fillColor: '#ef4444',
                fillOpacity: 0.5,
                radius: 6
            }).addTo(map);

            marker.bindPopup(`
                <div class="text-center">
                    <div class="font-bold text-white">${clock.name}</div>
                    <div class="text-xs text-gray-400">${clock.zone}</div>
                </div>
            `);
            mapMarkers.push(marker);
        }

        // --- Custom Clocks Management ---
        window.addClock = function (name, zone, lat, lng) {
            if (userClocks.some(c => c.name === name)) return;
            const newClock = { name, zone, lat, lng };
            userClocks.push(newClock);
            saveClocks();
            renderCustomClocks();
            addMarkerToMap(newClock);
            map.closePopup();
        };

        function removeClock(index) {
            userClocks.splice(index, 1);
            saveClocks();
            renderCustomClocks();
            mapMarkers.forEach(m => map.removeLayer(m));
            mapMarkers = [];
            userClocks.forEach(c => addMarkerToMap(c));
        }

        window.clearAllClocks = function () {
            if (!confirm("Remove all clocks?")) return;
            userClocks = [];
            saveClocks();
            renderCustomClocks();
            mapMarkers.forEach(m => map.removeLayer(m));
            mapMarkers = [];
        }

        function saveClocks() {
            localStorage.setItem('sdis_user_clocks', JSON.stringify(userClocks));
        }

        function renderCustomClocks() {
            const container = document.getElementById('custom-clocks-section');
            const grid = document.getElementById('my-clocks-grid');

            if (userClocks.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');

            grid.innerHTML = userClocks.map((c, i) => `
                <div class="min-panel p-3 relative group">
                    <button onclick="removeClock(${i})" class="absolute top-2 right-2 text-gray-600 hover:text-red-500 transition-colors">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                    <div class="text-[10px] font-bold text-gray-500 uppercase tracking-wide mb-1 truncate pr-4" title="${c.name}">${c.name}</div>
                    <div id="c-time-${i}" class="text-2xl text-white digit mb-0.5">--:--</div>
                    <div id="c-date-${i}" class="text-[9px] text-gray-600 font-mono">...</div>
                </div>
            `).join('');

            updateTime();
        }

        // --- Search Logic (Debounce) ---
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        function initSearch() {
            const input = document.getElementById("city-search");
            const spinner = document.getElementById("search-spinner");
            let currentFocus = -1;

            const fetchCities = async (query) => {
                if (!query || query.length < 2) {
                    closeAllLists();
                    return;
                }

                spinner.classList.remove('hidden');

                try {
                    // Using Open-Meteo Geocoding API (No key required, generous limits)
                    const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=10&language=en&format=json`);
                    const data = await response.json();

                    spinner.classList.add('hidden');
                    closeAllLists();

                    if (!data.results || data.results.length === 0) return;

                    const list = document.createElement("DIV");
                    list.setAttribute("id", input.id + "autocomplete-list");
                    list.setAttribute("class", "autocomplete-items");
                    input.parentNode.appendChild(list);

                    data.results.forEach(city => {
                        const item = document.createElement("DIV");
                        const country = city.country_code ? city.country_code : '';
                        const admin = city.admin1 ? `, ${city.admin1}` : '';

                        // Highlight matching text
                        const nameRegex = new RegExp(`(${query})`, 'gi');
                        const displayName = city.name.replace(nameRegex, '<span class="ac-highlight">$1</span>');

                        item.innerHTML = `
                            <div>
                                <span class="text-white">${displayName}</span>
                                <span class="ac-meta">${city.country || country}${admin}</span>
                            </div>
                            ${city.country_code ? `<img src="https://flagcdn.com/16x12/${city.country_code.toLowerCase()}.png" class="ml-2 opacity-70">` : ''}
                        `;

                        item.addEventListener("click", function (e) {
                            input.value = city.name;
                            closeAllLists();

                            // If API provided timezone, great. If not, fallback to fetching it.
                            if (city.timezone) {
                                addClock(city.name, city.timezone, city.latitude, city.longitude);
                                // Pan map
                                map.flyTo([city.latitude, city.longitude], 6);
                            } else {
                                // Fallback logic via map click handler flow
                                handleMapClick(city.latitude, city.longitude);
                            }
                        });
                        list.appendChild(item);
                    });

                } catch (e) {
                    console.error("Geocoding failed", e);
                    spinner.classList.add('hidden');
                }
            };

            const debouncedFetch = debounce(fetchCities, 300);

            input.addEventListener("input", function (e) {
                debouncedFetch(this.value);
            });

            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != input) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }

            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }

        window.addEventListener('load', init);

    </script>
</body>

</html>
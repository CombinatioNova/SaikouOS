<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Saikou | SDIS Admin</title>
    <meta name="description" content="Secure Department of Institutional Security administration panel." />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet" />

    <style>
        :root {
            --bg-main: #000000;
            --panel-bg: #0a0a0a;
            --border: #333333;
            --text-main: #ffffff;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* --- UI Components --- */
        .min-panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        /* Buttons */
        .min-btn {
            background: white;
            color: black;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: opacity 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .min-btn:hover {
            opacity: 0.9;
        }

        .min-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .min-btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: #ccc;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .min-btn-outline:hover {
            border-color: #666;
            color: white;
            background: #111;
        }

        .min-btn-danger {
            background: #3f0c0c;
            border: 1px solid #7f1d1d;
            color: #fca5a5;
        }

        .min-btn-danger:hover {
            background: #7f1d1d;
            color: white;
        }

        /* Inputs */
        .min-input {
            background-color: #000;
            border: 1px solid var(--border);
            color: white;
            border-radius: 6px;
            padding: 8px 12px;
            outline: none;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            width: 100%;
            transition: border-color 0.2s;
        }

        .min-input:focus {
            border-color: #666;
        }

        .min-select {
            background-color: #000;
            border: 1px solid var(--border);
            color: white;
            border-radius: 6px;
            padding: 8px 12px;
            outline: none;
            font-size: 12px;
        }

        /* Grid & Table */
        .data-grid-header {
            display: grid;
            grid-template-columns: 3fr 1fr 3fr 2fr 1.5fr 2fr;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 10px;
            text-transform: uppercase;
            color: #666;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .data-row {
            display: grid;
            grid-template-columns: 3fr 1fr 3fr 2fr 1.5fr 2fr;
            padding: 12px 16px;
            border-bottom: 1px solid #1a1a1a;
            align-items: center;
            transition: background 0.1s;
        }

        .data-row:hover {
            background: #111;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        /* Terminal */
        .terminal-window {
            font-family: 'JetBrains Mono', monospace;
            background: #050505;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .log-entry {
            padding: 4px 8px;
            border-bottom: 1px solid #111;
            font-size: 11px;
            display: flex;
            gap: 8px;
        }

        .log-time {
            color: #444;
            min-width: 60px;
        }

        .log-success {
            color: #10b981;
        }

        .log-error {
            color: #ef4444;
        }

        .log-info {
            color: #3b82f6;
        }

        /* Badges */
        .badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            border: 1px solid transparent;
        }

        .badge-perm {
            background: #3f0c0c;
            color: #fca5a5;
            border-color: #7f1d1d;
        }

        .badge-temp {
            background: #2e1a05;
            color: #fcd34d;
            border-color: #78350f;
        }

        .badge-active {
            background: #062c19;
            color: #6ee7b7;
            border-color: #064e3b;
        }

        /* Utils */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #000;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .poi-glow {
            animation: pulse-danger 3s infinite;
        }

        @keyframes pulse-danger {

            0%,
            100% {
                box-shadow: 0 0 0 rgba(239, 68, 68, 0);
            }

            50% {
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.2);
            }
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-black/90 border-b border-[#222] px-4 py-4 backdrop-blur-md">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <!-- UPDATED NAVBAR: SDIS Branding + Admin Text -->
            <a href="#" onclick="location.reload()" class="flex items-center gap-3 group">
                <!-- LOGO CHANGE: SDIS.svg -->
                <img src="SDIS.svg" class="h-8 w-auto object-contain transition-transform group-hover:scale-105"
                    alt="SDIS" onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden')">
                <!-- Fallback if SVG is missing in preview -->
                <div class="w-2 h-2 bg-white rounded-full hidden"></div>

                <div class="font-bold text-lg tracking-tight text-white group-hover:text-gray-200 transition-colors">
                    SDIS <span class="text-gray-600 font-normal group-hover:text-gray-500">/ SDIS Admin</span></div>
            </a>

            <div id="auth-ui">
                <!-- Logged In User Info -->
                <div id="user-card" class="hidden flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <div id="user-name" class="text-sm font-bold leading-none text-white"></div>
                        <div id="user-rank" class="text-[10px] text-gray-500 uppercase mt-1 font-mono"></div>
                    </div>
                    <img id="user-pfp" class="w-9 h-9 rounded bg-gray-900 border border-[#333] object-cover">
                    <button onclick="handleLogout()" class="text-gray-500 hover:text-white"><i
                            class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8 min-h-screen">

        <!-- Direct Login Interface (If not authed) -->
        <div id="login-interface" class="hidden flex flex-col items-center justify-center min-h-[60vh]">
            <div class="min-panel p-8 w-full max-w-sm bg-black border border-[#333] shadow-2xl">
                <div class="mb-6 border-b border-[#333] pb-4">
                    <h3 class="text-xl font-bold text-white mb-1">Authentication</h3>
                    <p class="text-xs text-gray-500">Enter SDIS security passphrase.</p>
                </div>

                <div class="space-y-4">
                    <input type="password" id="login-code"
                        class="min-input w-full text-center tracking-widest font-bold text-lg" placeholder="PASSPHRASE">
                    <button onclick="handleLogin()" id="btn-auth-submit" class="min-btn w-full justify-center py-3">
                        Authenticate
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="hidden space-y-6">

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="min-panel p-4 flex justify-between items-center">
                    <div>
                        <div class="text-[10px] text-gray-500 uppercase font-bold">Total Bans</div>
                        <div id="stat-total" class="text-2xl font-bold text-white mt-1">-</div>
                    </div>
                    <i class="fas fa-gavel text-gray-700 text-xl"></i>
                </div>
                <div class="min-panel p-4 flex justify-between items-center">
                    <div>
                        <div class="text-[10px] text-gray-500 uppercase font-bold">Active Today</div>
                        <div id="stat-today" class="text-2xl font-bold text-white mt-1">-</div>
                    </div>
                    <i class="fas fa-calendar-day text-gray-700 text-xl"></i>
                </div>
                <div class="min-panel p-4 flex justify-between items-center">
                    <div>
                        <div class="text-[10px] text-gray-500 uppercase font-bold">This Week</div>
                        <div id="stat-week" class="text-2xl font-bold text-white mt-1">-</div>
                    </div>
                    <i class="fas fa-chart-line text-gray-700 text-xl"></i>
                </div>
                <div class="min-panel p-4 flex justify-between items-center border-green-900/30 bg-green-900/5">
                    <div>
                        <div class="text-[10px] text-green-500/70 uppercase font-bold">System Status</div>
                        <div class="text-lg font-bold text-green-500 mt-1 flex items-center gap-2">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> ONLINE
                        </div>
                    </div>
                    <i class="fas fa-server text-green-900 text-xl"></i>
                </div>
            </div>

            <!-- Toolbar -->
            <div class="flex flex-wrap gap-3 justify-between items-center">
                <div class="flex gap-2">
                    <button onclick="openModal('modal-ban')"
                        class="min-btn bg-red-600 text-white border-none hover:bg-red-700">
                        <i class="fas fa-ban"></i> Issue Ban
                    </button>
                    <button onclick="openModal('modal-revoke')" class="min-btn-outline">
                        <i class="fas fa-undo"></i> Revoke
                    </button>
                </div>
                <div class="flex gap-2">
                    <button onclick="openModal('modal-audit')" class="min-btn-outline">
                        <i class="fas fa-terminal"></i> Audit Log
                    </button>
                    <button onclick="loadBanData()" class="min-btn-outline">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Main Ban List -->
            <div class="min-panel overflow-hidden flex flex-col h-[600px]">
                <!-- Filter Header -->
                <div class="p-3 border-b border-[#333] flex gap-3 bg-[#050505]">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-3 top-2.5 text-gray-600 text-xs"></i>
                        <input type="text" id="search-input" class="min-input pl-8"
                            placeholder="Search by username or ID...">
                    </div>
                    <select id="filter-type" class="min-select w-32 bg-black border border-[#333] text-gray-300">
                        <option value="">All Types</option>
                        <option value="permban">Permanent</option>
                        <option value="tempban">Temporary</option>
                        <option value="warning">Warning</option>
                    </select>
                </div>

                <!-- Grid Header -->
                <div class="data-grid-header bg-[#0a0a0a]">
                    <div>Target</div>
                    <div>Type</div>
                    <div>Reason</div>
                    <div>Moderator</div>
                    <div>Date</div>
                    <div class="text-right">Actions</div>
                </div>

                <!-- List Content -->
                <div id="ban-list" class="overflow-y-auto custom-scroll flex-1 relative">
                    <!-- Injected Rows -->
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 gap-2">
                        <div class="w-6 h-6 border-2 border-t-white border-gray-800 rounded-full animate-spin"></div>
                        <div class="text-xs font-mono">Accessing database...</div>
                    </div>
                </div>

                <!-- Pagination -->
                <div
                    class="p-3 border-t border-[#333] bg-[#050505] flex justify-between items-center text-xs text-gray-500">
                    <div id="page-info">Showing 0-0 of 0</div>
                    <div class="flex gap-2">
                        <button id="prev-btn" class="hover:text-white disabled:opacity-30" disabled>Previous</button>
                        <button id="next-btn" class="hover:text-white disabled:opacity-30" disabled>Next</button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- MODALS -->

    <!-- Issue Ban Modal -->
    <div id="modal-ban" class="modal-backdrop">
        <div class="min-panel p-6 w-full max-w-md bg-black shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-white border-b border-[#333] pb-2">Issue Sanction</h3>

            <div class="space-y-3">
                <div>
                    <label class="text-[10px] uppercase text-gray-500 font-bold">Target User</label>
                    <div class="flex gap-2 mt-1">
                        <input type="text" id="ban-target" class="min-input" placeholder="Username or ID">
                        <button onclick="previewUser()" class="min-btn-outline px-3"><i
                                class="fas fa-search"></i></button>
                    </div>
                </div>

                <!-- Preview Box -->
                <div id="user-preview"
                    class="hidden bg-[#111] border border-[#333] rounded p-3 flex items-center gap-3">
                    <img id="prev-avatar" class="w-10 h-10 rounded bg-black" src="">
                    <div>
                        <div id="prev-name" class="text-sm font-bold text-white"></div>
                        <div id="prev-id" class="text-xs text-gray-500 font-mono"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] uppercase text-gray-500 font-bold">Sanction Type</label>
                        <select id="ban-type" class="min-select w-full mt-1">
                            <option value="permban">Permanent Ban</option>
                            <option value="tempban">Temporary Ban</option>
                            <option value="warning">Warning</option>
                        </select>
                    </div>
                    <div id="duration-group" class="hidden">
                        <label class="text-[10px] uppercase text-gray-500 font-bold">Duration (Days)</label>
                        <input type="number" id="ban-duration" class="min-input mt-1" value="7" min="1">
                    </div>
                </div>

                <div>
                    <label class="text-[10px] uppercase text-gray-500 font-bold">Reason</label>
                    <textarea id="ban-reason" class="min-input w-full h-24 mt-1 resize-none"
                        placeholder="Enter detailed reason..."></textarea>
                </div>
            </div>

            <div class="flex gap-2 mt-4 pt-4 border-t border-[#333]">
                <button onclick="submitBan()"
                    class="min-btn bg-red-600 text-white border-none hover:bg-red-700 flex-1">Confirm Action</button>
                <button onclick="closeModals()" class="min-btn-outline flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Revoke Modal -->
    <div id="modal-revoke" class="modal-backdrop">
        <div class="min-panel p-6 w-full max-w-sm bg-black shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-white">Revoke Sanction</h3>
            <div class="space-y-3">
                <input type="text" id="revoke-target" class="min-input" placeholder="Username or ID">
                <textarea id="revoke-reason" class="min-input w-full h-24 resize-none"
                    placeholder="Reason for revocation..."></textarea>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="submitRevoke()"
                    class="min-btn bg-green-600 text-white border-none hover:bg-green-700 flex-1">Revoke</button>
                <button onclick="closeModals()" class="min-btn-outline flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Audit Terminal -->
    <div id="modal-audit" class="modal-backdrop">
        <div class="min-panel p-0 w-full max-w-4xl bg-[#050505] shadow-2xl flex flex-col h-[600px]">
            <div class="p-3 border-b border-[#333] flex justify-between items-center bg-[#0a0a0a]">
                <div class="flex items-center gap-2">
                    <i class="fas fa-terminal text-gray-500"></i>
                    <span class="font-bold text-sm">System Audit Log</span>
                </div>
                <div class="flex gap-2">
                    <select id="audit-filter" class="min-select h-8 py-1 text-xs">
                        <option value="">ALL EVENTS</option>
                        <option value="BAN_ISSUED">BAN_ISSUED</option>
                        <option value="BAN_REVOKED">BAN_REVOKED</option>
                        <option value="LOGIN_SUCCESS">AUTH_SUCCESS</option>
                    </select>
                    <button onclick="closeModals()" class="text-gray-500 hover:text-white px-2"><i
                            class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="audit-terminal" class="flex-1 overflow-y-auto custom-scroll p-2 font-mono text-xs">
                <!-- Logs go here -->
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const SDIS_WORKER = 'https://sdis-admin.saikoudevelopment.workers.dev';
        // UPDATED: Matches netvis2 and lookup 2.0
        const AUTH_WORKER = 'https://sdis-authenticator.saikoudevelopment.workers.dev';

        // --- State ---
        let state = {
            user: null,
            token: null,
            bans: [],
            page: 1,
            totalPages: 1,
            totalRecords: 0
        };

        // --- Avatar Engine (Ported from Lookup 2.0) ---
        const IMG_CACHE = new Map();
        async function getAvatar(id, name) {
            if (!id) return `https://placehold.co/150x150/333/FFF?text=${(name || '?').charAt(0)}`;
            if (IMG_CACHE.has(id)) return IMG_CACHE.get(id);

            const proxies = [
                (t) => `https://corsproxy.io/?${encodeURIComponent(t)}`,
                (t) => `https://api.allorigins.win/raw?url=${encodeURIComponent(t)}`
            ];
            const target = `https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${id}&size=150x150&format=Png&isCircular=false`;

            for (const p of proxies) {
                try {
                    const r = await fetch(p(target));
                    if (!r.ok) continue;
                    const d = await r.json();
                    const url = d.data?.[0]?.imageUrl;
                    if (url) {
                        IMG_CACHE.set(id, url);
                        return url;
                    }
                } catch (e) { }
            }
            return `https://placehold.co/150x150/333/FFF?text=${(name || '?').charAt(0)}`;
        }

        // --- Auth Logic ---
        function init() {
            const u = localStorage.getItem('sdis_user');
            const t = localStorage.getItem('sdis_token');
            if (u && t) {
                state.user = JSON.parse(u);
                state.token = t;
            }
            renderUI();
        }

        function renderUI() {
            const isAuth = !!state.token;

            // Toggle Login Interface vs Dashboard
            document.getElementById('login-interface').classList.toggle('hidden', isAuth);
            document.getElementById('dashboard').classList.toggle('hidden', !isAuth);

            // Navbar Auth UI (Only show user card if logged in)
            document.getElementById('user-card').classList.toggle('hidden', !isAuth);

            if (isAuth) {
                document.getElementById('user-name').textContent = state.user.displayName || state.user.username;
                document.getElementById('user-rank').textContent = state.user.sdisRole || 'OPERATIVE';
                getAvatar(state.user.id || state.user.userId, state.user.username).then(url => {
                    document.getElementById('user-pfp').src = url;
                });
                loadBanData();
            }
        }

        async function handleLogin() {
            const btn = document.getElementById('btn-auth-submit');
            const codeInput = document.getElementById('login-code');
            const code = codeInput.value.trim();

            if (!code) return;

            btn.disabled = true;
            const ogText = btn.innerText;
            btn.innerText = "Verifying...";

            try {
                const r = await fetch(`${AUTH_WORKER}/login`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ codePhrase: code })
                });
                const d = await r.json();
                if (d.success) {
                    state.user = d.user; state.token = d.token;
                    localStorage.setItem('sdis_user', JSON.stringify(d.user));
                    localStorage.setItem('sdis_token', d.token);
                    codeInput.value = ''; // Clear sensitive data
                    renderUI();
                } else {
                    alert(d.error || "Access Denied");
                }
            } catch (e) {
                console.error(e);
                alert("Connection Error: Unable to reach authentication server.");
            } finally {
                btn.disabled = false;
                btn.innerText = ogText;
            }
        }

        function handleLogout() {
            state.user = null; state.token = null;
            localStorage.removeItem('sdis_user');
            localStorage.removeItem('sdis_token');
            renderUI();
        }

        // --- Ban Management ---
        async function loadBanData(page = 1) {
            const search = document.getElementById('search-input').value;
            const type = document.getElementById('filter-type').value;

            const container = document.getElementById('ban-list');
            container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-500"><div class="w-6 h-6 border-2 border-t-white border-gray-800 rounded-full animate-spin mb-2"></div><div class="text-xs font-mono">Fetching records...</div></div>`;

            try {
                const url = new URL(`${SDIS_WORKER}/bans`);
                url.searchParams.append('page', page);
                url.searchParams.append('limit', 30);
                if (search) url.searchParams.append('search', search);
                if (type) url.searchParams.append('filter', type);

                const r = await fetch(url, { headers: { 'Authorization': `Bearer ${state.token}` } });

                if (r.status === 401 || r.status === 403) {
                    handleLogout();
                    alert("Session Expired. Please login again.");
                    return;
                }

                const d = await r.json();

                if (d.success) {
                    state.bans = d.bans;
                    state.page = d.pagination.page;
                    state.totalPages = d.pagination.totalPages;
                    state.totalRecords = d.pagination.total;

                    renderBanList();
                    updateStats(d.stats);
                    updatePagination();
                }
            } catch (e) {
                container.innerHTML = `<div class="p-4 text-center text-red-500 text-xs font-mono">Error loading data.</div>`;
            }
        }

        function renderBanList() {
            const c = document.getElementById('ban-list');
            c.innerHTML = '';

            state.bans.forEach(async ban => {
                const row = document.createElement('div');
                row.className = 'data-row';

                // Avatar handling
                const avatarId = `av-${ban.RobloxID}`;
                getAvatar(ban.RobloxID, ban.RobloxUsername).then(u => {
                    const el = document.getElementById(avatarId);
                    if (el) el.src = u;
                });

                // Styles
                const typeClass = ban.banType === 'tempban' ? 'badge-temp' : ban.banType === 'warning' ? 'badge-active' : 'badge-perm';
                const typeLabel = ban.banType === 'tempban' ? 'TEMPORARY' : ban.banType === 'warning' ? 'WARNING' : 'PERMANENT';
                const isPoi = ban.isPOI;

                row.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="relative">
                            <img id="${avatarId}" src="https://placehold.co/32x32/111/FFF" class="w-8 h-8 rounded bg-[#111] border ${isPoi ? 'border-red-500 poi-glow' : 'border-[#333]'}">
                            ${isPoi ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-red-600 rounded-full flex items-center justify-center text-[8px] font-bold text-white">!</div>' : ''}
                        </div>
                        <div class="min-w-0">
                            <div class="text-xs font-bold text-white truncate hover:text-blue-400 cursor-pointer" onclick="window.open('lookup.html?lookup=${ban.RobloxID}', '_blank')">${ban.RobloxUsername}</div>
                            <div class="text-[9px] text-gray-500 font-mono">${ban.RobloxID}</div>
                        </div>
                    </div>
                    <div><span class="badge ${typeClass}">${typeLabel}</span></div>
                    <div class="text-xs text-gray-400 truncate pr-4" title="${ban.Reason}">${ban.Reason}</div>
                    <div class="text-xs text-gray-500 font-mono">${ban.Moderator}</div>
                    <div class="text-[10px] text-gray-500 font-mono">${new Date(ban.Date).toLocaleDateString()}</div>
                    <div class="text-right flex justify-end gap-1">
                        <button onclick="quickRevoke('${ban.RobloxUsername}')" class="min-btn-outline px-2 py-1 h-6 text-[10px] border-green-900 text-green-500 hover:bg-green-900/20">REVOKE</button>
                        <button onclick="window.open('lookup.html?lookup=${ban.RobloxID}', '_blank')" class="min-btn-outline px-2 py-1 h-6 text-[10px]"><i class="fas fa-external-link-alt"></i></button>
                    </div>
                `;
                c.appendChild(row);
            });
        }

        function updateStats(s) {
            if (s) {
                document.getElementById('stat-total').innerText = s.total.toLocaleString();
                document.getElementById('stat-today').innerText = s.today.toLocaleString();
                document.getElementById('stat-week').innerText = s.thisWeek.toLocaleString();
            }
        }

        function updatePagination() {
            const info = document.getElementById('page-info');
            const prev = document.getElementById('prev-btn');
            const next = document.getElementById('next-btn');

            const start = (state.page - 1) * 30 + 1;
            const end = Math.min(state.page * 30, state.totalRecords);

            info.innerText = `Showing ${start}-${end} of ${state.totalRecords}`;
            prev.disabled = state.page <= 1;
            next.disabled = state.page >= state.totalPages;

            prev.onclick = () => loadBanData(state.page - 1);
            next.onclick = () => loadBanData(state.page + 1);
        }

        // --- Actions ---
        async function previewUser() {
            const t = document.getElementById('ban-target').value;
            if (!t) return;

            const prev = document.getElementById('user-preview');
            prev.classList.remove('hidden');
            document.getElementById('prev-name').innerText = "Searching...";

            try {
                const r = await fetch(`${SDIS_WORKER}/user/${t}`);
                const d = await r.json();
                if (d.success) {
                    document.getElementById('prev-name').innerText = d.user.displayName;
                    document.getElementById('prev-id').innerText = d.user.id;
                    getAvatar(d.user.id, d.user.name).then(u => document.getElementById('prev-avatar').src = u);
                } else {
                    document.getElementById('prev-name').innerText = "User Not Found";
                }
            } catch { document.getElementById('prev-name').innerText = "Error"; }
        }

        async function submitBan() {
            const user = document.getElementById('ban-target').value;
            const type = document.getElementById('ban-type').value;
            const reason = document.getElementById('ban-reason').value;
            const duration = document.getElementById('ban-duration').value;

            if (!user || !reason) return alert("Missing fields");

            const durVal = type === 'tempban' ? `${duration} days` : 'permanent';

            try {
                const r = await fetch(`${SDIS_WORKER}/ban/submit`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.token}` },
                    body: JSON.stringify({ userId: user, reason: reason, duration: durVal })
                });
                const d = await r.json();
                if (d.success) {
                    closeModals();
                    loadBanData();
                    alert("Ban Issued Successfully");
                } else alert(d.error);
            } catch (e) { alert("Failed to issue ban"); }
        }

        async function submitRevoke() {
            const user = document.getElementById('revoke-target').value;
            const reason = document.getElementById('revoke-reason').value;
            if (!user || !reason) return alert("Missing fields");

            try {
                const r = await fetch(`${SDIS_WORKER}/unban/submit`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.token}` },
                    body: JSON.stringify({ userId: user, reason: reason })
                });
                const d = await r.json();
                if (d.success) {
                    closeModals();
                    loadBanData();
                    alert("Ban Revoked");
                } else alert(d.error);
            } catch { alert("Failed"); }
        }

        function quickRevoke(username) {
            document.getElementById('revoke-target').value = username;
            openModal('modal-revoke');
        }

        // --- Audit Log ---
        async function loadAuditLog() {
            const filter = document.getElementById('audit-filter').value;
            const term = document.getElementById('audit-terminal');
            term.innerHTML = `<div class="text-gray-500">Fetching logs...</div>`;

            try {
                const url = new URL(`${SDIS_WORKER}/audit`);
                url.searchParams.append('limit', 100);
                if (filter) url.searchParams.append('filter', filter);

                const r = await fetch(url, { headers: { 'Authorization': `Bearer ${state.token}` } });
                const d = await r.json();

                if (d.success) {
                    term.innerHTML = d.logs.map(l => {
                        let color = 'text-white';
                        if (l.action.includes('BAN')) color = 'text-red-400';
                        if (l.action.includes('REVOKE')) color = 'text-green-400';

                        const details = JSON.stringify(l.details || {}).replace(/"/g, '');
                        return `
                            <div class="log-entry">
                                <div class="log-time font-mono text-[10px] text-gray-600">${new Date(l.timestamp).toLocaleTimeString()}</div>
                                <div class="w-24 flex-shrink-0 font-bold ${color}">${l.action}</div>
                                <div class="text-blue-400 w-24 flex-shrink-0">${l.user}</div>
                                <div class="text-gray-500 truncate flex-1">${details}</div>
                            </div>
                        `;
                    }).join('');
                }
            } catch { term.innerHTML = `<div class="text-red-500">Log Fetch Failed</div>`; }
        }

        // --- Utils ---
        function openModal(id) { document.getElementById(id).classList.add('active'); if (id === 'modal-audit') loadAuditLog(); }
        function closeModals() { document.querySelectorAll('.modal-backdrop').forEach(m => m.classList.remove('active')); }

        document.getElementById('ban-type').addEventListener('change', (e) => {
            document.getElementById('duration-group').classList.toggle('hidden', e.target.value !== 'tempban');
        });

        // Event Listeners
        document.getElementById('search-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') loadBanData(); });
        document.getElementById('login-code').addEventListener('keydown', (e) => { if (e.key === 'Enter') handleLogin(); });
        document.getElementById('filter-type').addEventListener('change', () => loadBanData());
        document.getElementById('audit-filter').addEventListener('change', loadAuditLog);

        // Init
        init();

    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Saikou Tools | Discord Search</title>
    <meta name="description" content="Discord User Reputation and Threat Assessment Tool." />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />

    <style>
        :root {
            --bg-main: #000000;
            --panel-bg: #0a0a0a;
            --border: #333333;
            --text-main: #ffffff;
            --text-muted: #888888;
            --accent-discord: #5865F2;
            --accent-red: #ef4444;
            --accent-yellow: #eab308;
            --accent-green: #22c55e;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Panel & Layout */
        .min-panel { background-color: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; }
        
        /* Inputs & Search */
        .search-group {
            background-color: #000; border: 1px solid var(--border); border-radius: 8px;
            display: flex; align-items: center; padding: 4px 6px; transition: border-color 0.2s;
        }
        .search-group:focus-within { border-color: #ffffff; }
        .search-input {
            background: transparent; border: none; color: white; padding: 12px; width: 100%; font-size: 16px; outline: none;
        }
        .search-action-btn {
            background: #ffffff; color: black; border-radius: 6px; padding: 8px 16px; font-weight: 600; font-size: 14px; transition: opacity 0.2s;
        }
        .search-action-btn:hover { opacity: 0.9; }

        /* Buttons & Utils */
        .min-btn-outline { background: transparent; border: 1px solid var(--border); color: #ccc; padding: 8px 16px; border-radius: 6px; font-size: 14px; transition: all 0.2s; }
        .min-btn-outline:hover { border-color: #666; color: white; background: #111; }
        
        .min-input { background-color: #000; border: 1px solid var(--border); color: white; border-radius: 6px; padding: 8px 12px; outline: none; width: 100%; }
        .min-input:focus { border-color: #666; }

        /* Terminal */
        .terminal-window { font-family: 'JetBrains Mono', monospace; background: #050505; border: 1px solid var(--border); }
        .log-entry { padding: 2px 0; word-break: break-word; }
        .log-entry.success { color: #10b981; font-weight: bold; }
        .log-entry.info { color: #9ca3af; }
        .log-entry.error { color: #ef4444; }
        .log-entry.warn { color: #f59e0b; }
        .log-entry.system { color: var(--accent-discord); font-weight: bold; }

        /* Risk Bar */
        .risk-bar-fill { height: 100%; transition: width 1s ease; }
        
        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #111; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Animation */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .animate-pulse-fast { animation: blink 1s infinite; }
    </style>
</head>

<body>

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 bg-black/90 border-b border-[#222] px-4 py-4 backdrop-blur-md">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <a href="#" onclick="location.reload()" class="flex items-center gap-2">
                <div class="w-2 h-2 bg-white rounded-full shadow-[0_0_10px_rgba(255,255,255,0.4)]"></div>
                <div class="font-bold text-lg tracking-tight text-white">Saikou Tools <span class="text-gray-600 font-normal">/ Discord Search</span></div>
            </a>
            
            <div id="auth-status" class="flex items-center gap-3">
                 <span class="text-[10px] text-green-500 font-mono border border-green-900 bg-green-900/10 px-2 py-1 rounded">WORKER LINKED</span>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-10 min-h-screen">
        <!-- Search Section -->
        <div class="text-center mb-12">
            <h1 class="text-3xl font-bold mb-3 text-white tracking-tight">Discord Identity Trace</h1>
            <p class="text-gray-500 text-sm mb-6">Enter a User ID to retrieve reputation and server intelligence.</p>
            <div class="max-w-lg mx-auto">
                <div class="search-group">
                    <i class="fab fa-discord text-gray-600 ml-3"></i>
                    <input type="text" id="search-input" class="search-input" placeholder="Discord User ID (e.g. 1298496899443195927)" autocomplete="off">
                    <button id="search-btn" class="search-action-btn">Scan</button>
                </div>
            </div>
        </div>

        <!-- Terminal / Loading State -->
        <div id="terminal" class="hidden max-w-3xl mx-auto mb-8 min-panel bg-black font-mono text-xs shadow-2xl shadow-black/50">
            <div class="border-b border-[#333] px-3 py-2 text-gray-500 flex justify-between items-center">
                <div class="flex gap-2">
                     <div class="w-3 h-3 rounded-full bg-indigo-900/50 border border-indigo-800"></div>
                </div>
                <span class="text-[10px] uppercase tracking-widest text-indigo-500">TASE_LINK_V1</span>
                <span id="status-indicator" class="text-indigo-500 animate-pulse-fast">PROCESSING</span>
            </div>
            <div id="logs" class="p-4 h-64 overflow-y-auto custom-scroll space-y-1 text-gray-400 bg-[#050505]"></div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-container" class="hidden pb-20">
            <!-- Content injected via JS -->
        </div>
    </main>

    <script>
        // --- State ---
        const WORKER_URL = 'https://tase.saikoudevelopment.workers.dev';
        let app = {
            targetId: '',
            reputationData: null,
            discordProfile: null
        };

        // --- UI Utils ---
        function log(msg, type='info') {
            const d = document.createElement('div');
            d.className = `log-entry ${type} font-mono text-[11px]`;
            d.innerHTML = `<span class="opacity-30 mr-2">${new Date().toLocaleTimeString().split(' ')[0]}</span>${msg}`;
            const c = document.getElementById('logs');
            if(c) { c.appendChild(d); c.scrollTop = c.scrollHeight; }
        }

        function formatSnowflake(id) {
            // Converts Snowflake ID to Timestamp
            const DISCORD_EPOCH = 1420070400000;
            const timestamp = (BigInt(id) >> 22n) + BigInt(DISCORD_EPOCH);
            return new Date(Number(timestamp));
        }

        function formatNumber(num) { 
            return num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "0"; 
        }

        // --- API Logic ---
        async function fetchDiscordProfile(id) {
            log('Querying Discord API (Via Secure Worker)...', 'system');
            
            try {
                // We fetch through the worker's /discord/ route.
                // The worker injects the DISCORD_BOT_TOKEN from its secrets.
                const response = await fetch(`${WORKER_URL}/discord/v10/users/${id}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                         log(`Discord User Not Found (Invalid ID?)`, 'error');
                    } else {
                        log(`Discord API Error: ${response.status}`, 'warn');
                    }
                    return null;
                }
                
                const data = await response.json();
                log('Metadata Retrieved.', 'success');
                return data;
            } catch (e) {
                log('Worker Connection Failed (Discord Route).', 'error');
                console.error(e);
                return null;
            }
        }

        async function search(inputOverride) {
            const query = inputOverride || document.getElementById('search-input').value.trim();
            if(!query) return;

            app.targetId = query;
            document.getElementById('search-input').value = query;

            // UI Reset
            document.getElementById('dashboard-container').innerHTML = '';
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('terminal').classList.remove('hidden');
            document.getElementById('logs').innerHTML = '';

            log('Initializing Discord Intelligence Trace...');
            await new Promise(r => setTimeout(r, 400));

            try {
                // 1. Fetch Discord Profile
                const profilePromise = fetchDiscordProfile(query);
                
                // 2. Fetch TASE Reputation (via Worker)
                log(`Connecting to TASE Network...`);
                // The Worker injects the TASE_API_KEY from secrets
                const workerReq = fetch(`${WORKER_URL}/api/v1/check/${query}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const [profile, taseResponse] = await Promise.all([profilePromise, workerReq]);
                app.discordProfile = profile;

                let taseData = null;
                if (taseResponse.ok) {
                    taseData = await taseResponse.json();
                    log('TASE Reputation Stream Acquired.', 'success');
                } else if(taseResponse.status === 404) {
                    log('User not found in TASE database (Clean Record).', 'success');
                    taseData = { scoreSum: 0, guilds: [] }; // Mock clean data
                } else {
                    throw new Error(`TASE API Error: ${taseResponse.status}`);
                }
                
                app.reputationData = taseData;
                await new Promise(r => setTimeout(r, 600)); // Dramatic effect
                renderDashboard();

            } catch (e) {
                log(`FATAL ERROR: ${e.message}`, 'error');
                console.error(e);
            }
        }

        function calculateRisk(tase) {
            let score = tase.scoreSum || 0;
            let rating = "Safe";
            let color = "text-green-500";
            let barColor = "bg-green-500";
            let rBorder = "border-green-600";
            let reasons = { positive: [], negative: [] };

            // Calculate Flags
            if (tase.guilds && tase.guilds.length > 0) {
                reasons.negative.push({ text: `Detected in ${tase.guilds.length} Flagged Servers`, weight: -10, icon: "fa-server" });
                
                const condoCount = tase.guilds.filter(g => g.name.toLowerCase().includes('condo') || g.type.includes('Condo')).length;
                if(condoCount > 0) reasons.negative.push({ text: `${condoCount} Confirmed Condo Connections`, weight: -20, icon: "fa-link" });
                
                const staffCount = tase.guilds.filter(g => g.isStaff).length;
                if(staffCount > 0) reasons.negative.push({ text: `Staff in ${staffCount} Flagged Server(s)`, weight: -50, icon: "fa-gavel" });
            } else {
                reasons.positive.push({ text: "No adverse records found in database", weight: 0, icon: "fa-check" });
            }

            if (score > 100) score = 100; // Cap visual score

            if (score > 50) {
                rating = "CRITICAL";
                color = "text-red-500";
                barColor = "bg-red-600";
                rBorder = "border-red-600";
            } else if (score > 10) {
                rating = "SUSPICIOUS";
                color = "text-yellow-500";
                barColor = "bg-yellow-500";
                rBorder = "border-yellow-500";
            } else if (score > 0) {
                rating = "LOW RISK";
                color = "text-orange-400";
                barColor = "bg-orange-400";
                rBorder = "border-orange-400";
            } else {
                rating = "SAFE";
            }

            return { score, rating, color, barColor, rBorder, reasons };
        }

        function renderDashboard() {
            document.getElementById('terminal').classList.add('hidden');
            const container = document.getElementById('dashboard-container');
            container.classList.remove('hidden');

            const p = app.discordProfile || {};
            const t = app.reputationData || { scoreSum: 0, guilds: [] };
            const risk = calculateRisk(t);

            // Avatar Logic
            let avatarUrl = "https://cdn.discordapp.com/embed/avatars/0.png";
            if (p.id && p.avatar) {
                avatarUrl = `https://cdn.discordapp.com/avatars/${p.id}/${p.avatar}.png?size=256`;
            }

            // Banner Logic
            let bannerHtml = '';
            if (p.banner) {
                const bannerUrl = `https://cdn.discordapp.com/banners/${p.id}/${p.banner}.png?size=600`;
                bannerHtml = `<div class="h-32 w-full bg-cover bg-center" style="background-image: url('${bannerUrl}');"></div>`;
            } else if (p.accent_color) {
                bannerHtml = `<div class="h-32 w-full" style="background-color: #${p.accent_color.toString(16).padStart(6, '0')};"></div>`;
            } else {
                bannerHtml = `<div class="h-32 w-full bg-gradient-to-r from-[#111] to-[#222]"></div>`;
            }

            // Creation Date
            const createdAt = app.targetId ? formatSnowflake(app.targetId) : new Date();

            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- LEFT COLUMN: Identity -->
                    <div class="space-y-6">
                        <div class="min-panel text-center relative overflow-hidden">
                             ${bannerHtml}
                             <div class="px-6 pb-6 relative">
                                <div class="relative -mt-16 mb-4 inline-block">
                                    <img src="${avatarUrl}" class="w-32 h-32 rounded-full border-4 border-[#0a0a0a] bg-[#111] object-cover">
                                    ${risk.rating === 'CRITICAL' ? '<div class="absolute bottom-1 right-1 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow border border-black animate-pulse">THREAT</div>' : ''}
                                </div>
                                
                                <h2 class="text-2xl font-bold text-white leading-tight">${p.global_name || p.username || 'Unknown User'}</h2>
                                <p class="text-sm text-gray-500 font-mono mb-6">
                                    ${p.username ? '@'+p.username : 'Unknown'} 
                                    <span class="mx-1">|</span> 
                                    ID: ${app.targetId}
                                </p>

                                <div class="grid grid-cols-2 gap-2 pt-4 border-t border-[#333]">
                                    <div>
                                        <div class="text-[10px] text-gray-600 uppercase font-bold">Created</div>
                                        <div class="text-xs text-gray-300 font-mono">${createdAt.toLocaleDateString()}</div>
                                    </div>
                                    <div>
                                        <div class="text-[10px] text-gray-600 uppercase font-bold">Bot?</div>
                                        <div class="text-xs text-white font-mono">${p.bot ? '<span class="text-indigo-400">YES</span>' : 'NO'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                         <div class="min-panel p-5 space-y-3 text-sm">
                            <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Discord Flags</h3>
                            ${getDiscordFlags(p)}
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: Intelligence -->
                    <div class="lg:col-span-2 space-y-6">
                        
                         <!-- RISK PANEL -->
                        <div class="min-panel p-6 border-l-2 ${risk.rBorder}">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-lg font-bold text-white">Threat Assessment</h3>
                                    <div class="text-xs font-mono mt-1 text-gray-500 uppercase tracking-widest ${risk.color}">${risk.rating} LEVEL</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-4xl font-black ${risk.color}">${t.scoreSum || 0}</div>
                                    <div class="text-[9px] text-gray-600 uppercase">Reputation Score</div>
                                </div>
                            </div>
                            <div class="w-full bg-[#222] h-2 rounded-full overflow-hidden mb-6">
                                <div class="risk-bar-fill ${risk.barColor}" style="width: ${Math.min(100, (t.scoreSum||0))}%"></div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                ${risk.reasons.negative.map(r => `<div class="border border-[#333] bg-red-900/5 p-2 rounded flex items-center justify-between"><div class="flex items-center gap-2 overflow-hidden"><div class="w-6 h-6 rounded-full bg-red-900/20 text-red-500 flex items-center justify-center text-[10px] flex-shrink-0"><i class="fas ${r.icon}"></i></div><span class="text-xs text-gray-300 truncate" title="${r.text}">${r.text}</span></div><span class="text-xs font-mono text-red-500 font-bold ml-2">FLAG</span></div>`).join('')}
                                ${risk.reasons.positive.map(r => `<div class="border border-[#333] bg-green-900/5 p-2 rounded flex items-center justify-between"><div class="flex items-center gap-2 overflow-hidden"><div class="w-6 h-6 rounded-full bg-green-900/20 text-green-500 flex items-center justify-center text-[10px] flex-shrink-0"><i class="fas ${r.icon}"></i></div><span class="text-xs text-gray-300 truncate" title="${r.text}">${r.text}</span></div><span class="text-xs font-mono text-green-500 font-bold ml-2">OK</span></div>`).join('')}
                            </div>
                        </div>

                        <!-- Servers Panel -->
                        <div class="min-panel p-5 flex flex-col h-[500px]">
                            <div class="flex justify-between items-center mb-4 border-b border-[#333] pb-4">
                                <div>
                                    <h3 class="text-sm font-bold text-white uppercase flex items-center gap-2">
                                        <i class="fas fa-server text-indigo-500"></i> Server Intelligence
                                    </h3>
                                    <p class="text-[10px] text-gray-500 mt-0.5">Communities where subject was detected.</p>
                                </div>
                                <span class="text-xs bg-[#222] text-gray-300 px-2 py-1 rounded font-mono border border-[#333]">${t.guilds ? t.guilds.length : 0} Hits</span>
                            </div>

                            <div class="space-y-2 overflow-y-auto custom-scroll flex-1 pr-2">
                                ${t.guilds && t.guilds.length > 0 ? t.guilds.map(g => `
                                    <div class="flex items-start justify-between p-3 border border-[#222] bg-[#111] hover:border-red-900 hover:bg-red-900/5 rounded transition-colors group">
                                        <div class="flex items-start gap-3 overflow-hidden">
                                            <div class="w-10 h-10 bg-[#222] rounded-full flex-shrink-0 flex items-center justify-center text-gray-600 border border-[#333]">
                                                <i class="fas fa-dungeon text-sm group-hover:text-red-500 transition-colors"></i>
                                            </div>
                                            <div class="min-w-0">
                                                <div class="text-sm text-gray-200 font-bold truncate pr-4">${g.name}</div>
                                                <div class="flex items-center gap-2 mt-1">
                                                    <span class="text-[10px] text-gray-500 uppercase tracking-wider bg-[#000] px-1.5 rounded border border-[#333]">${g.type || 'Unknown'}</span>
                                                    ${g.isStaff ? '<span class="text-[10px] text-red-400 bg-red-900/20 px-1.5 rounded border border-red-900/30 font-bold">STAFF</span>' : ''}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-right flex-shrink-0">
                                            <div class="text-xs font-mono text-red-500 font-bold mb-1">+${g.score} Risk</div>
                                            <div class="flex flex-col gap-0.5">
                                                <div class="text-[10px] text-gray-500" title="First Seen"><i class="fas fa-clock text-[9px] mr-1 opacity-50"></i>First: ${g.firstSeen ? new Date(g.firstSeen).toLocaleDateString() : '?'}</div>
                                                <div class="text-[10px] text-gray-400" title="Last Seen"><i class="fas fa-history text-[9px] mr-1 opacity-50"></i>Last: ${g.lastSeen ? new Date(g.lastSeen).toLocaleDateString() : '?'}</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div class="flex flex-col items-center justify-center h-full text-gray-700">
                                        <i class="fas fa-shield-alt text-4xl mb-3 opacity-20"></i>
                                        <p class="text-xs uppercase tracking-widest font-bold mt-2">No Records Found</p>
                                    </div>
                                `}
                            </div>
                        </div>

                    </div>
                </div>
            `;
        }

        function getDiscordFlags(p) {
            if(!p || !p.flags) return '<div class="text-gray-600 text-xs italic">No flags returned</div>';
            // Simple check for flags (this is simplistic as flags are bitfields)
            // For robust flag checking, we would need bitwise operations against known flags
            // Displaying raw flags if available, or just badges
            
            const badges = [];
            if(p.public_flags & 1) badges.push({name: "Staff", icon: "fa-hammer"});
            if(p.public_flags & 2) badges.push({name: "Partner", icon: "fa-handshake"});
            if(p.public_flags & 4) badges.push({name: "HypeSquad", icon: "fa-calendar"});
            if(p.public_flags & 8) badges.push({name: "Bug Hunter 1", icon: "fa-bug"});
            if(p.public_flags & 64) badges.push({name: "Bravery", icon: "fa-shield-alt"});
            if(p.public_flags & 128) badges.push({name: "Brilliance", icon: "fa-lightbulb"});
            if(p.public_flags & 256) badges.push({name: "Balance", icon: "fa-balance-scale"});
            if(p.public_flags & 512) badges.push({name: "Early Supporter", icon: "fa-gem"});
            
            if(badges.length === 0) return '<div class="text-gray-600 text-xs italic">No public flags</div>';

            return `
                <div class="grid grid-cols-2 gap-2">
                    ${badges.map(b => `<div class="flex justify-between items-center"><span class="text-gray-500">${b.name}</span><i class="fas ${b.icon} text-white text-xs"></i></div>`).join('')}
                </div>
            `;
        }

        document.getElementById('search-input').addEventListener('keydown', (e) => { if(e.key==='Enter') search(); });
        document.getElementById('search-btn').onclick = () => search();

    </script>
</body>
</html>

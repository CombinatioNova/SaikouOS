<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Saikou | User Lookup</title>
    <meta name="description" content="Mod Intelligence Tool - Roblox user information and threat assessment." />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Added Montserrat -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&family=Montserrat:wght@700;800&display=swap"
        rel="stylesheet" />

    <style>
        :root {
            --bg-main: #000000;
            --panel-bg: #0a0a0a;
            --border: #333333;
            --text-main: #ffffff;
            --text-muted: #888888;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-discord: #5865F2;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Panel & Layout */
        .min-panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        /* Inputs & Search */
        .search-group {
            background-color: #000;
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 4px 6px;
            transition: border-color 0.2s;
        }

        .search-group:focus-within {
            border-color: #ffffff;
        }

        .search-input {
            background: transparent;
            border: none;
            color: white;
            padding: 12px;
            width: 100%;
            font-size: 16px;
            outline: none;
        }

        .search-action-btn {
            background: #ffffff;
            color: black;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 14px;
            transition: opacity 0.2s;
        }

        .search-action-btn:hover {
            opacity: 0.9;
        }

        /* Navigation Buttons */
        .nav-btn {
            color: #555;
            padding: 8px 12px;
            transition: all 0.2s;
            cursor: pointer;
            border-radius: 4px;
        }

        .nav-btn:hover:not(:disabled) {
            color: #fff;
            background: #111;
        }

        .nav-btn:disabled {
            color: #222;
            cursor: not-allowed;
        }

        /* Buttons */
        .min-btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: #ccc;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .min-btn-outline:hover {
            border-color: #666;
            color: white;
            background: #111;
        }

        .min-btn {
            background: white;
            color: black;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            border: none;
            transition: opacity 0.2s;
        }

        .min-btn:hover {
            opacity: 0.9;
        }

        .min-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .min-input {
            background-color: #000;
            border: 1px solid var(--border);
            color: white;
            border-radius: 6px;
            padding: 8px 12px;
            outline: none;
        }

        .min-input:focus {
            border-color: #666;
        }

        /* Terminal */
        .terminal-window {
            font-family: 'JetBrains Mono', monospace;
            background: #050505;
            border: 1px solid var(--border);
        }

        .log-entry {
            padding: 2px 0;
            word-break: break-word;
        }

        .log-entry.success {
            color: #10b981;
            font-weight: bold;
        }

        .log-entry.info {
            color: #9ca3af;
        }

        .log-entry.error {
            color: #ef4444;
        }

        .log-entry.warn {
            color: #f59e0b;
        }

        .log-entry.system {
            color: var(--accent-discord);
            font-weight: bold;
        }

        /* Risk Bar */
        .risk-bar-fill {
            height: 100%;
            transition: width 1s ease;
        }

        /* Modals */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        /* Grid & Utils */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #111;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Animation */
        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        .animate-pulse-fast {
            animation: blink 1s infinite;
        }

        /* POI Special Styling */
        @keyframes pulse-danger {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(220, 38, 38, 0.1);
                border-color: rgba(220, 38, 38, 0.3);
            }

            50% {
                box-shadow: 0 0 25px rgba(220, 38, 38, 0.2);
                border-color: rgba(220, 38, 38, 0.6);
            }
        }

        .poi-alert-card {
            background-color: rgba(69, 10, 10, 0.3);
            /* dark red bg */
            border: 1px solid rgba(220, 38, 38, 0.4);
            border-radius: 0.5rem;
            padding: 1rem;
            animation: pulse-danger 3s infinite;
        }

        .poi-border {
            border-color: #dc2626 !important;
        }

        /* Custom Select for Link Modal */
        select.min-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 14px;
            padding-right: 30px;
        }

        /* Expandable Linked Account Cards */
        .linked-account-card {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .linked-account-card:hover {
            border-color: #555 !important;
        }

        .linked-account-card.expanded {
            border-color: #666 !important;
        }

        .linked-account-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin-top 0.3s ease;
            opacity: 0;
        }

        .linked-account-details.show {
            max-height: 300px;
            opacity: 1;
            margin-top: 0.75rem;
        }

        .expand-indicator {
            transition: transform 0.3s ease;
        }

        .expand-indicator.rotated {
            transform: rotate(180deg);
        }
    </style>
</head>

<body>

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 bg-black/90 border-b border-[#222] px-4 py-4 backdrop-blur-md">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <a href="/" class="flex items-center gap-3">
                <!-- LOGO CHANGE: SDIS.svg -->
                <img src="SDIS.svg" class="h-8 w-auto object-contain" alt="SDIS"
                    onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden')">
                <!-- Fallback if SVG is missing in preview -->
                <div class="w-2 h-2 bg-white rounded-full hidden"></div>

                <div class="font-bold text-lg tracking-tight text-white">SDIS <span class="text-gray-600 font-normal">/
                        Lookup</span></div>
            </a>

            <!-- Auth UI -->
            <div id="auth-ui">
                <!-- Logged Out -->
                <div id="login-container">
                    <button id="btn-login"
                        class="min-btn-outline flex items-center gap-2 text-xs uppercase tracking-wider font-semibold">
                        <i class="fas fa-lock text-[10px]"></i> <span>SDIS Access</span>
                    </button>
                </div>
                <!-- Logged In -->
                <div id="user-card" class="hidden flex items-center gap-3">
                    <div class="text-right hidden sm:block">
                        <div id="user-name" class="text-sm font-bold leading-none text-white"></div>
                        <div id="user-rank" class="text-[10px] text-gray-500 uppercase mt-1 font-mono"></div>
                    </div>
                    <img id="user-pfp" class="w-9 h-9 rounded bg-gray-900 border border-[#333] object-cover">
                    <button id="btn-logout" class="text-gray-500 hover:text-white px-2 transition-colors"><i
                            class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-10 min-h-screen">
        <!-- Search Section -->
        <div class="text-center mb-12">
            <h1 class="text-3xl font-bold mb-3 text-white tracking-tight">Saikou Lookup System</h1>
            <p class="text-gray-500 text-sm mb-6">Enter a target identifier to retrieve threat assessment data.</p>
            <div class="max-w-lg mx-auto">
                <div class="search-group">
                    <!-- NEW: Navigation Buttons -->
                    <div class="flex items-center border-r border-[#333] pr-1 mr-1 gap-0.5">
                        <button id="btn-nav-back" class="nav-btn" disabled title="Go Back"><i
                                class="fas fa-chevron-left text-xs"></i></button>
                        <button id="btn-nav-fwd" class="nav-btn" disabled title="Go Forward"><i
                                class="fas fa-chevron-right text-xs"></i></button>
                    </div>
                    <i class="fas fa-search text-gray-600 ml-2"></i>
                    <input type="text" id="search-input" class="search-input" placeholder="Username or User ID"
                        autocomplete="off">
                    <button id="search-btn" class="search-action-btn">Search</button>
                </div>
            </div>
        </div>

        <!-- Terminal / Loading State -->
        <div id="terminal"
            class="hidden max-w-3xl mx-auto mb-8 min-panel bg-black font-mono text-xs shadow-2xl shadow-black/50">
            <div class="border-b border-[#333] px-3 py-2 text-gray-500 flex justify-between items-center">
                <div class="flex gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-900/50 border border-red-800"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-900/50 border border-yellow-800"></div>
                    <div class="w-3 h-3 rounded-full bg-green-900/50 border border-green-800"></div>
                </div>
                <span class="text-[10px] uppercase tracking-widest">System_Link_V2</span>
                <span id="status-indicator" class="text-green-500 animate-pulse-fast">ACTIVE</span>
            </div>
            <div id="logs" class="p-4 h-64 overflow-y-auto custom-scroll space-y-1 text-gray-400 bg-[#050505]"></div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-container" class="hidden pb-20">
            <!-- Content injected via JS -->
        </div>
    </main>

    <!-- Modals -->
    <!-- Login Modal -->
    <div id="modal-login" class="hidden modal-backdrop">
        <div class="min-panel p-6 w-full max-w-sm bg-black border border-[#333] shadow-2xl">
            <h3 class="text-lg font-bold mb-2 text-white">SDIS Authorization</h3>
            <p class="text-xs text-gray-500 mb-4">Enter your secure passphrase to continue.</p>
            <input type="password" id="login-code" class="min-input w-full mb-4" placeholder="Passphrase">
            <div class="flex gap-2">
                <button id="btn-login-submit" class="min-btn flex-1">Authenticate</button>
                <button onclick="closeModals()" class="min-btn-outline flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- POI Mark Modal -->
    <div id="modal-poi" class="hidden modal-backdrop">
        <div class="min-panel p-6 w-full max-w-md bg-black border border-[#333] shadow-2xl">
            <h3 class="text-lg font-bold mb-1 text-red-500 uppercase tracking-wider">Mark Subject</h3>
            <p class="text-xs text-gray-500 mb-4">Designate this user as a Person of Interest.</p>
            <div class="mb-4">
                <label class="block text-[10px] uppercase text-gray-500 mb-1">Reasoning</label>
                <textarea id="poi-reason" class="min-input w-full h-32 resize-none text-sm p-3"
                    placeholder="Detailed reason for designation..."></textarea>
            </div>
            <div class="flex gap-2">
                <button id="btn-poi-submit"
                    class="min-btn bg-red-600 text-white border-none hover:bg-red-700 flex-1">Confirm
                    Designation</button>
                <button onclick="closeModals()" class="min-btn-outline flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Ring Selection Modal -->
    <div id="modal-ring-select" class="hidden modal-backdrop">
        <div class="min-panel p-6 w-full max-w-sm bg-black border border-[#333]">
            <h3 id="ring-modal-title" class="text-lg font-bold mb-4 text-white">Ring Management</h3>
            <div id="ring-list" class="space-y-2 max-h-60 overflow-y-auto custom-scroll mb-4"></div>
            <div class="flex gap-2">
                <button id="btn-ring-confirm" class="min-btn flex-1">Confirm</button>
                <button onclick="closeModals()" class="min-btn-outline flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Create Ring Modal -->
    <div id="modal-ring-create" class="hidden modal-backdrop">
        <div class="min-panel p-6 w-full max-w-sm bg-black border border-[#333]">
            <h3 class="text-lg font-bold mb-4 text-white">Add New Ring</h3>
            <input type="text" id="new-ring-name" class="min-input w-full mb-3" placeholder="Ring Name">
            <textarea id="new-ring-desc" class="min-input w-full h-20 mb-3 resize-none"
                placeholder="Description (Optional)"></textarea>
            <label class="flex items-center gap-2 text-xs text-gray-400 mb-4 cursor-pointer">
                <input type="checkbox" id="new-ring-auto-add" checked class="rounded bg-black border-[#333]">
                Add subject to this ring
            </label>
            <div class="flex gap-2">
                <button id="btn-ring-create-submit" class="min-btn flex-1">Add Ring</button>
                <button onclick="closeModals()" class="min-btn-outline flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Link / Alt Modal -->
    <div id="modal-add-link" class="hidden modal-backdrop">
        <div class="min-panel p-6 w-full max-w-sm bg-black border border-[#333] shadow-2xl relative">
            <div class="absolute top-0 left-0 w-full h-1 bg-purple-500"></div>
            <h3 class="text-lg font-bold mb-1 text-white">Link Identity</h3>
            <p class="text-xs text-gray-500 mb-4">Connect an alternate account or external identity.</p>

            <div class="space-y-3">
                <div>
                    <label class="text-[10px] uppercase text-gray-500 font-bold mb-1 block">Platform</label>
                    <select id="link-platform-select" class="min-input text-xs w-full">
                        <option value="roblox">Roblox</option>
                        <option value="discord">Discord</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div>
                    <label class="text-[10px] uppercase text-gray-500 font-bold mb-1 block">Identifier</label>
                    <div class="flex gap-2">
                        <input type="text" id="link-id" class="min-input text-xs flex-1"
                            placeholder="User ID (e.g. 156322)">
                        <button id="btn-verify-link"
                            class="bg-[#111] hover:bg-[#222] border border-[#333] text-white px-3 rounded transition-colors"><i
                                class="fas fa-search"></i></button>
                    </div>
                </div>

                <!-- Preview Area -->
                <div id="verify-preview"
                    class="hidden bg-[#050505] border border-[#333] rounded p-2 flex items-center gap-3">
                    <img id="verify-img" src="" class="w-8 h-8 rounded bg-black border border-[#333]">
                    <div class="overflow-hidden">
                        <div id="verify-name" class="text-xs font-bold text-white truncate">User</div>
                        <div id="verify-id" class="text-[9px] text-gray-500 font-mono truncate">ID: 123</div>
                    </div>
                    <div class="ml-auto text-green-500"><i class="fas fa-check-circle"></i></div>
                </div>

                <div>
                    <label class="text-[10px] uppercase text-gray-500 font-bold mb-1 block">Confidence</label>
                    <select id="link-confidence-select" class="min-input text-xs w-full">
                        <option value="CERTAIN">Certain (Confirmed)</option>
                        <option value="LIKELY">Likely (Strong Evidence)</option>
                        <option value="PLAUSIBLE">Plausible (Suspected)</option>
                    </select>
                </div>

                <div class="flex gap-2 pt-2">
                    <button id="btn-submit-link" class="min-btn flex-1 bg-purple-600 hover:bg-purple-500 text-white"
                        disabled>Add Link</button>
                    <button onclick="closeModals(); resetVerify();" class="min-btn-outline flex-1">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Merge Confirmation Modal -->
    <div id="modal-merge-confirm" class="hidden modal-backdrop">
        <div class="min-panel p-6 w-full max-w-md bg-black border border-[#333] shadow-2xl relative">
            <div class="absolute top-0 left-0 w-full h-1 bg-yellow-500"></div>
            <div class="flex items-start gap-3 mb-4">
                <div class="w-10 h-10 rounded-full bg-yellow-900/20 border border-yellow-600 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-code-branch text-yellow-500 text-lg"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white">Profile Merge Required</h3>
                    <p class="text-xs text-gray-400 mt-1">Connection detected between profiles</p>
                </div>
            </div>

            <div class="bg-[#0a0a0a] border border-[#222] rounded p-3 mb-4">
                <p class="text-sm text-gray-300 leading-relaxed mb-3">
                    This <span id="merge-platform" class="text-white font-bold"></span> account is already linked to a different profile. 
                    This means you've discovered that these accounts belong to the same person!
                </p>
                <div class="space-y-2 text-xs">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-user text-blue-400 w-4"></i>
                        <span class="text-gray-500">Current Profile:</span>
                        <span id="merge-current-profile" class="text-white font-mono"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-link text-purple-400 w-4"></i>
                        <span class="text-gray-500">Linking:</span>
                        <span id="merge-linking-account" class="text-white font-mono"></span>
                    </div>
                </div>
            </div>

            <div class="bg-yellow-900/10 border border-yellow-900/30 rounded p-3 mb-4">
                <div class="flex items-start gap-2">
                    <i class="fas fa-info-circle text-yellow-500 text-sm mt-0.5"></i>
                    <p class="text-xs text-yellow-200/80">
                        Merging will combine all linked accounts from both profiles into this one. This action cannot be undone.
                    </p>
                </div>
            </div>

            <div class="flex gap-2">
                <button id="btn-merge-confirm" class="min-btn flex-1 bg-yellow-600 hover:bg-yellow-500 text-white">
                    <i class="fas fa-code-branch mr-2"></i>Merge Profiles
                </button>
                <button onclick="closeModals()" class="min-btn-outline flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Delete Link Confirmation Modal -->
    <div id="modal-delete-link" class="hidden modal-backdrop">
        <div class="min-panel p-6 w-full max-w-md bg-black border border-[#333] shadow-2xl relative">
            <div class="absolute top-0 left-0 w-full h-1 bg-red-500"></div>
            <div class="flex items-start gap-3 mb-4">
                <div class="w-10 h-10 rounded-full bg-red-900/20 border border-red-600 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-unlink text-red-500 text-lg"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white">Remove Linked Account</h3>
                    <p class="text-xs text-gray-400 mt-1">This will unlink the identity from this profile</p>
                </div>
            </div>

            <div class="bg-[#0a0a0a] border border-[#222] rounded p-3 mb-4">
                <div class="flex items-center gap-3 mb-2">
                    <img id="delete-link-avatar" src="" class="w-10 h-10 rounded bg-[#111] border border-[#333] object-cover">
                    <div class="min-w-0 flex-1">
                        <div id="delete-link-name" class="text-sm font-bold text-white truncate">Account Name</div>
                        <div class="flex items-center gap-1.5">
                            <div id="delete-link-platform" class="text-[9px] text-gray-500 uppercase font-bold tracking-wider">Platform</div>
                            <div class="w-0.5 h-0.5 bg-gray-700 rounded-full"></div>
                            <div id="delete-link-id" class="text-[9px] text-gray-600 font-mono">ID</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-red-900/10 border border-red-900/30 rounded p-3 mb-4">
                <div class="flex items-start gap-2">
                    <i class="fas fa-exclamation-triangle text-red-500 text-sm mt-0.5"></i>
                    <p class="text-xs text-red-200/80">
                        This will remove the link between this account and the profile. The account itself will not be deleted.
                    </p>
                </div>
            </div>

            <div class="flex gap-2">
                <button id="btn-delete-link-confirm" class="min-btn flex-1 bg-red-600 hover:bg-red-500 text-white">
                    <i class="fas fa-trash mr-2"></i>Remove Link
                </button>
                <button onclick="closeModals()" class="min-btn-outline flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const ENG_FREQ = {
            'a': 8.167, 'b': 1.492, 'c': 2.782, 'd': 4.253, 'e': 12.702, 'f': 2.228,
            'g': 2.015, 'h': 6.094, 'i': 6.966, 'j': 0.153, 'k': 0.772, 'l': 4.025,
            'm': 2.406, 'n': 6.749, 'o': 7.507, 'p': 1.929, 'q': 0.095, 'r': 5.987,
            's': 6.327, 't': 9.056, 'u': 2.758, 'v': 0.978, 'w': 2.360, 'x': 0.150,
            'y': 1.974, 'z': 0.074
        };
        // Expanded Dictionary for better detection
        const COMMON_WORDS = new Set([
            // Articles, Pronouns, Prepositions
            "the", "be", "to", "of", "and", "a", "in", "that", "have", "i", "it", "for", "not", "on", "with", "he", "as", "you", "do", "at", "this", "but", "his", "by", "from", "they", "we", "say", "her", "she", "or", "an", "will", "my", "one", "all", "would", "there", "their", "what", "so", "up", "out", "if", "about", "who", "get", "which", "go", "me", "when", "make", "can", "like", "time", "no", "just", "him", "know", "take", "people", "into", "year", "your", "good", "some", "could", "them", "see", "other", "than", "then", "now", "look", "only", "come", "its", "over", "think", "also", "back", "after", "use", "two", "how", "our", "work", "first", "well", "way", "even", "new", "want", "because", "any", "these", "give", "day", "most", "us",
            // Common Verbs & Nouns
            "is", "are", "was", "were", "been", "has", "had", "do", "does", "did", "done", "said", "says", "went", "gone", "made", "make", "know", "known", "thought", "think", "take", "taken", "saw", "seen", "come", "came", "put", "set", "found", "find", "told", "tell", "ask", "asked", "seem", "seemed", "feel", "felt", "try", "tried", "leave", "left", "call", "called",
            "time", "person", "year", "way", "day", "thing", "man", "world", "life", "hand", "part", "child", "eye", "woman", "place", "work", "week", "case", "point", "government", "company", "number", "group", "problem", "fact",
            // Adjectives
            "big", "high", "different", "small", "large", "next", "early", "young", "important", "few", "public", "bad", "same", "able",
            // Tech / Crypto / CTF Specific
            "flag", "secret", "password", "code", "admin", "root", "login", "user", "username", "pass", "key", "token", "auth", "session", "cookie", "hidden", "message", "encrypted", "cipher", "text", "string", "hash", "value", "data", "system", "access", "denied", "granted", "success", "fail", "error", "warning", "level", "stage", "phase", "clue", "hint", "solve", "solution", "answer", "correct", "wrong", "true", "false", "null", "void", "return", "function", "var", "let", "const", "class", "import", "export", "from",
            // Gaming / Roblox / Platform Specific
            "roblox", "rbx", "robux", "dev", "developer", "studio", "script", "lua", "exploit", "hack", "cheat", "banned", "ban", "kick", "server", "client", "obby", "tycoon", "simulator", "roleplay", "rp", "avatar", "skin", "item", "trade", "limited", "ugc", "group", "clan", "raid", "alt", "main", "smurf", "discord", "cord", "disc", "vc", "voice", "chat", "mod", "admin", "owner", "creator", "builder", "gui",
            // Safety / Moderation / Flagged Terms (Predator Behavior Indicators)
            "age", "old", "young", "boy", "girl", "pic", "picture", "photo", "snap", "insta", "kik", "meet", "irl", "real", "life", "address", "school", "live", "where", "location", "send", "nude", "sexy", "hot", "cute", "love", "baby", "daddy", "mommy", "secret", "private", "dm", "pm", "message", "hidden", "room", "house", "bed", "sleep", "touch", "kiss", "trust", "promise", "video", "cam", "webcam", "naked", "body"
        ]);

        const AUTH_WORKER = 'https://sdis-authenticator.saikoudevelopment.workers.dev';
        const DATA_WORKER = 'https://saikou-ban-proxy.saikoudevelopment.workers.dev';
        const ROTECTOR_API = 'https://roscoe.robalyx.com/v1/lookup/roblox/user';
        const JUSTICE_PROXY = 'https://justice.saikoudevelopment.workers.dev';
        const TASE_WORKER = 'https://tase.saikoudevelopment.workers.dev';
        // NEW: EASI / ERP Detection Worker
        const EASI_WORKER = 'https://easi.saikoudevelopment.workers.dev';
        // NEW: MOCO-CO Worker
        const MOCOCO_WORKER = 'https://mococo-proxy.saikoudevelopment.workers.dev';
        // NEW: Linker Worker
        const LINKER_WORKER = 'https://sdislinker.saikoudevelopment.workers.dev';

        const OOFD_API_URL = 'https://oofd.net/api/ban/status/';

        const EXTERNAL_DATABASES = [];
        const LOCAL_THREAT_IDS = ["1"];
        const SAIKOU_GROUP_ID = "3149674";
        const SDIS_GROUP_ID = "549702194";

        // --- GLOBAL CIPHER TOOLS & DECRYPTION ENGINE ---
        const BAD_WORDS = ['join', 'discord', 'slut', 'cock', 'cum', 'fuck', 'nude', 'sex', 'dick', 'pussy', 'whore', 'rape', 'snuff', 'piss', 'bondage', 'bdsm', 'gore', 'kill', 'shoot', 'hitman', 'murder', 'traffick', 'bitch'];

        function sendNotification(title, message, isError = false) {
            // Check if running inside the OS (iframe)
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'SAIKOU_NOTIFICATION',
                    payload: {
                        title: title,
                        message: message,
                        appName: 'Lookup'
                    }
                }, '*');
            }

            // Fallback for standalone mode (only alert on errors to be less intrusive)
            if (window.parent === window && isError) {
                alert(`${title}: ${message}`);
            }
        }

        // --- ANALYSIS HELPERS (From decrypt.html) ---
        function cleanStr(str) { return str.toLowerCase().replace(/[^a-z]/g, ""); }

        function calculateIoC(text) {
            const clean = cleanStr(text);
            const len = clean.length;
            if (len <= 1) return 0;
            const counts = {};
            for (let char of clean) counts[char] = (counts[char] || 0) + 1;
            let numerator = 0;
            for (let char in counts) numerator += counts[char] * (counts[char] - 1);
            return (numerator / (len * (len - 1))) * 26;
        }

        function scoreText(text) {
            if (!text || text.length === 0) return -100;
            const lower = text.toLowerCase();
            const words = lower.split(/[\s,.-]+/);
            let wordScore = 0;

            words.forEach(w => {
                if (w.length > 1 && COMMON_WORDS.has(w)) wordScore += 10;
            });

            const clean = cleanStr(text);
            if (clean.length === 0) return -50;

            const counts = {};
            for (let c of clean) counts[c] = (counts[c] || 0) + 1;
            let chiSquared = 0;
            for (let char in ENG_FREQ) {
                const observed = counts[char] || 0;
                const expected = (ENG_FREQ[char] / 100) * clean.length;
                chiSquared += Math.pow(observed - expected, 2) / expected;
            }

            let finalScore = (wordScore * 2) - (chiSquared / 2);
            if (text.includes(" ")) finalScore += 5;
            return finalScore;
        }

        // --- CIPHER ALGORITHMS (From decrypt.html) ---
        function decryptCaesar(text, shift) {
            return text.replace(/[a-zA-Z]/g, char => {
                const base = char <= 'Z' ? 65 : 97;
                return String.fromCharCode(((char.charCodeAt(0) - base - shift + 26) % 26) + base);
            });
        }

        function decryptAtbash(text) {
            return text.replace(/[a-zA-Z]/g, char => {
                const base = char <= 'Z' ? 65 : 97;
                return String.fromCharCode(base + (25 - (char.charCodeAt(0) - base)));
            });
        }

        function decryptRailFence(text, rails) {
            const clean = text.replace(/\r?\n|\r/g, '');
            if (clean.length === 0 || rails <= 1) return clean;
            const cycle = 2 * (rails - 1);
            const len = clean.length;
            const fence = new Array(rails).fill(0).map(() => []);
            const railCounts = new Array(rails).fill(0);
            for (let i = 0; i < len; i++) {
                const pos = i % cycle;
                const row = pos < rails ? pos : cycle - pos;
                railCounts[row]++;
            }
            let index = 0;
            for (let r = 0; r < rails; r++) {
                for (let c = 0; c < railCounts[r]; c++) {
                    if (index < len) fence[r].push(clean[index++]);
                }
            }
            let result = "";
            const railIndices = new Array(rails).fill(0);
            for (let i = 0; i < len; i++) {
                const pos = i % cycle;
                const row = pos < rails ? pos : cycle - pos;
                if (fence[row][railIndices[row]]) {
                    result += fence[row][railIndices[row]];
                    railIndices[row]++;
                }
            }
            return result;
        }

        function escapeHtml(text) {
            return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
        }

        // --- SMART CRACKER ---
        function attemptCrack(text) {
            if (!text || typeof text !== 'string' || text.length < 3) return null;

            // 1. Calculate Score of Original Text
            // If the input is already coherent English, we shouldn't "crack" it into gibberish (Rail Fence hallucination)
            const originalScore = scoreText(text);

            let attempts = [];

            // 1. Base64
            try {
                const b64 = atob(text);
                attempts.push({ method: "Base64", text: b64, score: scoreText(b64) + 20 });
            } catch (e) { }

            // 2. Hex
            const cleanHex = text.replace(/\s/g, '');
            if (/^[0-9A-Fa-f]+$/.test(cleanHex) && cleanHex.length % 2 === 0) {
                let str = '';
                try {
                    for (let i = 0; i < cleanHex.length; i += 2) str += String.fromCharCode(parseInt(cleanHex.substr(i, 2), 16));
                    attempts.push({ method: "Hex", text: str, score: scoreText(str) + 20 });
                } catch (e) { }
            }

            // 3. Atbash
            const atb = decryptAtbash(text);
            attempts.push({ method: "Atbash", text: atb, score: scoreText(atb) });

            // 4. Caesar (Brute Force 1-25)
            for (let s = 1; s < 26; s++) {
                const res = decryptCaesar(text, s);
                attempts.push({ method: `Caesar (-${s})`, text: res, score: scoreText(res) });
            }

            // 5. Rail Fence (Brute Force 2-10)
            for (let r = 2; r <= 10; r++) {
                const res = decryptRailFence(text, r);
                attempts.push({ method: `Rail Fence (${r})`, text: res, score: scoreText(res) });
            }

            // Sort by Score
            attempts.sort((a, b) => b.score - a.score);

            const best = attempts[0];

            // Check for explicit triggers in the best result
            const lowerDec = best.text.toLowerCase();
            const badTrigger = BAD_WORDS.find(w => lowerDec.includes(w));

            if (badTrigger) {
                best.score += 50; // Boost score if we found a bad word (it means we successfully cracked a threat)
                best.confidence = "HIGH";
                best.hasThreat = true;
                best.trigger = badTrigger;
                return best;
            }

            // Anti-Hallucination Check:
            // If the "cracked" text doesn't score significantly better than the original text, 
            // assume the original text was the intended message (plain text).
            // This is critical for Rail Fence which preserves letter frequency and often tricks the scorer.
            if (originalScore > 10 && best.score < originalScore + 15) {
                return null;
            }

            // Return best result if it looks like English/Language
            if (best.score > 10) {
                if (best.score > 30) best.confidence = "HIGH";
                else if (best.score > 15) best.confidence = "POSSIBLE";
                else best.confidence = "LOW";
                return best;
            }

            return null;
        }

        let app = {
            user: null,
            token: null,
            profile: null,
            friends: [],
            groups: [],
            rings: [],
            bannedFriends: [],
            rotector: null,
            federatedBans: [],
            userRings: [],
            discordData: null,
            // NEW: EASI Data Holder
            easiData: null,
            // NEW: Moco-co Data Holder
            mococoData: null,
            // NEW: Linked Identities (Atlas)
            identities: [],
            friendSafety: new Map(),
            friendStats: { unsafe: 0, flagged: 0, scanned: 0, total: 0, errors: 0 },
            // NEW: History & Cache
            history: [],
            historyIndex: -1,
            cache: new Map(),
            // NEW: Link Verification Data
            linkVerifiedData: null
        };

        const IMG_CACHE = new Map();

        async function getAvatar(id, name) {
            if (!id || id === 'undefined') return `https://placehold.co/150x150/333/FFF?text=${(name || '?').charAt(0)}`;
            if (IMG_CACHE.has(id)) return IMG_CACHE.get(id);
            const placeholder = `https://placehold.co/150x150/333/FFF?text=${(name || '?').charAt(0)}`;

            const proxies = [
                (target) => `https://corsproxy.io/?${encodeURIComponent(target)}`,
                (target) => `https://api.allorigins.win/raw?url=${encodeURIComponent(target)}`
            ];
            const robloxApiUrl = `https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${id}&size=150x150&format=Png&isCircular=false`;

            for (const makeProxyUrl of proxies) {
                try {
                    const r = await fetch(makeProxyUrl(robloxApiUrl));
                    if (!r.ok) continue;
                    const data = await r.json();
                    const url = data.data?.[0]?.imageUrl;
                    if (url) {
                        IMG_CACHE.set(id, url);
                        document.querySelectorAll(`img[data-uid="${id}"]`).forEach(img => img.src = url);
                        return url;
                    }
                } catch (e) { }
            }
            return placeholder;
        }

        async function getDiscordAvatar(id) {
            if(IMG_CACHE.has(`discord:${id}`)) return IMG_CACHE.get(`discord:${id}`);
            // Default fallback immediately calculated on client side too
            let fallbackUrl = `https://cdn.discordapp.com/embed/avatars/0.png`;
            try { fallbackUrl = `https://cdn.discordapp.com/embed/avatars/${(BigInt(id) >> 22n) % 6n}.png`; } catch(e){}
            try {
                const res = await fetch(`${LINKER_WORKER}/resolve/discord?id=${id}`, {
                    headers: { 'Authorization': `Bearer ${app.token}` }
                });
                if(res.ok) {
                    const d = await res.json();
                    let url = fallbackUrl;
                    // If we have a real avatar hash
                    if(d.avatar) {
                        url = `https://cdn.discordapp.com/avatars/${d.id}/${d.avatar}.png`;
                    } // If the worker gave us a specific fallback
                    else if (d.fallback_avatar) {
                        url = d.fallback_avatar;
                    }
                    IMG_CACHE.set(`discord:${id}`, url);
                    return url;
                }
            } catch(e) { console.error(e); }
            return fallbackUrl;
        }

        // --- NEW: FETCH DISCORD DATA (Returns Full Object) ---
        async function resolveDiscordData(id) {
            // Ensure ID is a string and clean it
            const cleanId = String(id).trim();
            
            // Calculate default avatar index (used as fallback)
            let defaultAvatarIndex = 0;
            try {
                defaultAvatarIndex = Number((BigInt(cleanId) >> 22n) % 6n);
            } catch(e) {
                console.warn(`Could not calculate default avatar for ${cleanId}:`, e);
            }
            const defaultAvatar = `https://cdn.discordapp.com/embed/avatars/${defaultAvatarIndex}.png`;
            
            // Try worker resolution first (requires auth + bot token)
            if (app.token) {
                try {
                    const res = await fetch(`${LINKER_WORKER}/resolve/discord?id=${cleanId}`, { 
                        headers: { 'Authorization': `Bearer ${app.token}` } 
                    });
                    console.log(`Discord resolve for ${cleanId}:`, res.status);
                    
                    if (res.ok) {
                        const d = await res.json();
                        console.log(`Discord data for ${cleanId}:`, d);
                        
                        // Check if we got an error response even with 200 status
                        if (d.error) {
                            console.warn(`Discord API error:`, d.error);
                        } else {
                            // Worker returns the full Discord user object
                            let avatarUrl = defaultAvatar;
                            
                            // If user has custom avatar, use it
                            if (d.avatar) {
                                avatarUrl = `https://cdn.discordapp.com/avatars/${d.id}/${d.avatar}.png?size=128`;
                            } else if (d.fallback_avatar) {
                                // Use the fallback avatar provided by the worker
                                avatarUrl = d.fallback_avatar;
                            }
                            
                            // Determine display name (prefer global_name, fallback to username)
                            const displayName = d.global_name || d.username || `Discord User ${cleanId}`;
                            
                            return { 
                                id: d.id,
                                username: d.username || `User ${cleanId}`, 
                                discriminator: d.discriminator, 
                                globalName: d.global_name, 
                                avatarUrl: avatarUrl,
                                displayName: displayName,
                                isFallback: d._is_fallback || false
                            };
                        }
                    } else {
                        const errText = await res.text();
                        console.warn(`Discord API returned ${res.status}:`, errText);
                    }
                } catch (e) { 
                    console.error(`Discord resolve error for ${cleanId}:`, e);
                }
            }
            
            // Fallback: Try TASE worker as alternative (it might have cached Discord data)
            try {
                const taseRes = await fetch(`${TASE_WORKER}/discord/v10/users/${cleanId}`);
                if (taseRes.ok) {
                    const taseData = await taseRes.json();
                    console.log(`TASE Discord data for ${cleanId}:`, taseData);
                    
                    let avatarUrl = defaultAvatar;
                    if (taseData.avatar) {
                        avatarUrl = `https://cdn.discordapp.com/avatars/${taseData.id}/${taseData.avatar}.png?size=128`;
                    }
                    
                    const displayName = taseData.global_name || taseData.username || `Discord User`;
                    
                    return {
                        id: taseData.id,
                        username: taseData.username || `User ${cleanId}`,
                        discriminator: taseData.discriminator,
                        globalName: taseData.global_name,
                        avatarUrl: avatarUrl,
                        displayName: displayName,
                        isFallback: false
                    };
                }
            } catch (e) {
                console.warn(`TASE fallback failed for ${cleanId}:`, e);
            }
            
            // Final fallback: Use default avatar and show ID
            return { 
                id: cleanId,
                username: `Unknown User`, 
                displayName: `Discord User ${cleanId}`,
                avatarUrl: defaultAvatar,
                isFallback: true
            };
        }

        // --- NEW: FETCH ROBLOX DATA (Returns Object) ---
        async function resolveRobloxData(id) {
            try {
                const res = await fetch(`https://corsproxy.io/?https://users.roblox.com/v1/users/${id}`);
                const data = await res.json();
                const username = data.name || "Unknown Roblox User";
                const display = data.displayName || "";
                const avatarUrl = await getAvatar(id, username);
                return { username, display, avatarUrl };
            } catch(e) {
                return { username: "Unknown User", avatarUrl: "https://placehold.co/150x150/333/FFF?text=?" };
            }
        }

        // --- NEW: Async Data Hydrator for Linked Accounts ---
        async function hydrateLinkedAccounts(alts) {
            console.log(`Hydrating ${alts.length} linked accounts...`);
            
            for (const alt of alts) {
                // Keep ID as string to avoid floating point precision loss with large Discord IDs
                const cleanId = String(alt.platform_id).trim();
                const imgId = `linked-img-${alt.platform}-${cleanId}`;
                const nameId = `linked-name-${alt.platform}-${cleanId}`;
                const imgEl = document.getElementById(imgId);
                const nameEl = document.getElementById(nameId);
                
                if (!imgEl || !nameEl) {
                    console.warn(`Could not find elements for ${alt.platform}:${cleanId}`);
                    continue;
                }

                console.log(`Hydrating ${alt.platform}:${cleanId}...`);

                try {
                    if (alt.platform === 'roblox') {
                        const data = await resolveRobloxData(cleanId);
                        imgEl.src = data.avatarUrl;
                        nameEl.textContent = data.username;
                        if(data.display) nameEl.title = `Display: ${data.display}`;
                    } 
                    else if (alt.platform === 'discord') {
                        const data = await resolveDiscordData(cleanId);
                        console.log(`Discord hydration result:`, data);
                        
                        // Update avatar
                        imgEl.src = data.avatarUrl;
                        
                        // Update username display - show both global name and username
                        if (data.isFallback || data.username === "Unknown User") {
                            nameEl.textContent = `User ${cleanId}`;
                            nameEl.title = `Discord ID: ${cleanId} (Could not fetch username)`;
                        } else {
                            // Show both global name and username if they exist and are different
                            if (data.globalName && data.username && data.globalName !== data.username) {
                                nameEl.textContent = `${data.globalName} (@${data.username})`;
                                nameEl.title = `Display Name: ${data.globalName}\nUsername: @${data.username}`;
                            } else if (data.globalName) {
                                nameEl.textContent = data.globalName;
                                nameEl.title = `Display Name: ${data.globalName}`;
                            } else {
                                nameEl.textContent = data.username;
                                nameEl.title = `Username: @${data.username}`;
                            }
                        }
                    }
                } catch (e) {
                    console.error(`Failed to hydrate ${alt.platform}:${cleanId}`, e);
                    nameEl.textContent = `Error loading ${alt.platform}`;
                    nameEl.classList.add('text-red-400');
                }
            }
            
            console.log(`Hydration complete.`);
        }

        // --- UI Logic ---
        function log(msg, type = 'info') {
            const d = document.createElement('div');
            d.className = `log-entry ${type} font-mono text-[11px]`;
            d.innerHTML = `<span class="opacity-50 mr-2">${new Date().toLocaleTimeString().split(' ')[0]}</span>${msg}`;
            const c = document.getElementById('logs');
            if (c) { c.appendChild(d); c.scrollTop = c.scrollHeight; }
        }

        function toggleModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModals() { document.querySelectorAll('.modal-backdrop').forEach(m => m.classList.add('hidden')); }

        // --- Expandable Link Card Logic ---
        function toggleLinkCard(cardId, event) {
            // Don't toggle if clicking on a link or button
            if (event.target.tagName === 'A' || event.target.tagName === 'BUTTON' || event.target.closest('button') || event.target.closest('a')) {
                return;
            }
            
            const card = document.getElementById(cardId);
            if (!card) return;
            
            const details = card.querySelector('.linked-account-details');
            const indicator = card.querySelector('.expand-indicator');
            
            if (details.classList.contains('show')) {
                // Collapse
                details.classList.remove('show');
                indicator.classList.remove('rotated');
                card.classList.remove('expanded');
            } else {
                // Collapse all other cards first
                document.querySelectorAll('.linked-account-card').forEach(c => {
                    if (c.id !== cardId) {
                        c.querySelector('.linked-account-details')?.classList.remove('show');
                        c.querySelector('.expand-indicator')?.classList.remove('rotated');
                        c.classList.remove('expanded');
                    }
                });
                
                // Expand this card
                details.classList.add('show');
                indicator.classList.add('rotated');
                card.classList.add('expanded');
            }
        }

        // --- Delete Link Logic ---
        let pendingDeleteLink = null;

        async function confirmDeleteLink(platform, platformId) {
            pendingDeleteLink = { platform, platformId };
            
            // Get the current display info for the modal
            const cleanId = String(platformId).trim();
            const imgId = `linked-img-${platform}-${cleanId}`;
            const nameId = `linked-name-${platform}-${cleanId}`;
            
            const imgEl = document.getElementById(imgId);
            const nameEl = document.getElementById(nameId);
            
            // Populate modal
            document.getElementById('delete-link-avatar').src = imgEl?.src || 'https://placehold.co/40x40/111/444?text=?';
            document.getElementById('delete-link-name').textContent = nameEl?.textContent || 'Unknown';
            document.getElementById('delete-link-platform').textContent = platform.toUpperCase();
            document.getElementById('delete-link-id').textContent = cleanId;
            
            toggleModal('modal-delete-link');
        }

        async function deleteLink() {
            if (!pendingDeleteLink) return;
            
            const btn = document.getElementById('btn-delete-link-confirm');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Removing...';
            
            try {
                const res = await fetch(`${LINKER_WORKER}/identity`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${app.token}`
                    },
                    body: JSON.stringify({
                        platform: pendingDeleteLink.platform,
                        platformId: pendingDeleteLink.platformId
                    })
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Failed to delete link');
                }
                
                const result = await res.json();
                console.log('Delete result:', result);
                
                // Store platform name before clearing
                const deletedPlatform = pendingDeleteLink.platform;
                
                // Remove from local state
                app.identities = app.identities.filter(i => 
                    !(i.platform === pendingDeleteLink.platform && 
                      String(i.platform_id).trim() === String(pendingDeleteLink.platformId).trim())
                );
                
                // Clear cache
                app.cache.delete(String(app.profile.id));
                
                // Close modal
                closeModals();
                pendingDeleteLink = null;
                
                // Re-render the identity panel - just trigger a full refresh
                await search(String(app.profile.id));
                
                sendNotification('Link Removed', `${deletedPlatform} account unlinked successfully`);
                
            } catch (e) {
                console.error('Delete link error:', e);
                alert(`Error: ${e.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- Auth Logic ---
        function initAuth() {
            const u = localStorage.getItem('sdis_user');
            const t = localStorage.getItem('sdis_token');
            if (u && t) { app.user = JSON.parse(u); app.token = t; }
            renderAuth();
            updateNavButtons(); // Init nav state
        }

        function renderAuth() {
            const btn = document.getElementById('login-container');
            const card = document.getElementById('user-card');
            if (app.user) {
                btn.classList.add('hidden');
                card.classList.remove('hidden');
                document.getElementById('user-name').textContent = app.user.displayName || app.user.username;
                document.getElementById('user-rank').textContent = app.user.sdisRole || "Operative";
                const userId = app.user.id || app.user.userId || '0';
                const username = app.user.username || app.user.name || '?';
                getAvatar(userId, username).then(u => document.getElementById('user-pfp').src = u);
            } else {
                btn.classList.remove('hidden');
                card.classList.add('hidden');
            }
        }

        // --- NAVIGATION LOGIC ---
        function updateNavButtons() {
            const backBtn = document.getElementById('btn-nav-back');
            const fwdBtn = document.getElementById('btn-nav-fwd');

            backBtn.disabled = app.historyIndex <= 0;
            fwdBtn.disabled = app.historyIndex >= app.history.length - 1;
        }

        document.getElementById('btn-nav-back').onclick = () => {
            if (app.historyIndex > 0) {
                app.historyIndex--;
                const query = app.history[app.historyIndex];
                search(query, true);
            }
        };

        document.getElementById('btn-nav-fwd').onclick = () => {
            if (app.historyIndex < app.history.length - 1) {
                app.historyIndex++;
                const query = app.history[app.historyIndex];
                search(query, true);
            }
        };

        // ... (Auth handlers same as before) ...
        document.getElementById('btn-login').onclick = () => toggleModal('modal-login');
        document.getElementById('btn-logout').onclick = () => {
            app.user = null; app.token = null;
            localStorage.removeItem('sdis_user'); localStorage.removeItem('sdis_token');
            renderAuth();
        };

        document.getElementById('btn-login-submit').onclick = async () => {
            const code = document.getElementById('login-code').value.trim();
            if (!code) return;
            const btn = document.getElementById('btn-login-submit');
            btn.textContent = "Accessing..."; btn.disabled = true;
            try {
                // FIXED: body is now outside of headers
                const r = await fetch(`${AUTH_WORKER}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ codePhrase: code })
                });
                const d = await r.json();
                if (d.success) {
                    app.user = d.user; app.token = d.token;
                    localStorage.setItem('sdis_user', JSON.stringify(d.user));
                    localStorage.setItem('sdis_token', d.token);
                    closeModals(); renderAuth();
                    document.getElementById('login-code').value = '';
                    sendNotification('System Access', `Welcome back, ${d.user.username}`);
                } else sendNotification('Login Failed', d.error || "Access Denied", true);
            } catch (e) { sendNotification("System Access", e || "Connection Failure", true); }
            btn.textContent = "Authenticate"; btn.disabled = false;
        };

        // --- Data Fetch Helpers ---
        async function checkOOFD(userId) {
            try {
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(OOFD_API_URL)}`;
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ UserId: String(userId) })
                });
                if (!response.ok) return [];
                const data = await response.json();
                const bans = [];
                if (data.Banned === true && data.Data) {
                    const entries = Array.isArray(data.Data) ? data.Data : [data.Data];
                    entries.forEach(entry => {
                        let reason = "";
                        const bannedBy = (entry.BannedBy || "").toUpperCase();
                        switch (bannedBy) {
                            case 'SYNAPSE': reason = "Registered Synapse Owner (Exploit Injector)"; break;
                            case 'KRNL': reason = "Registered KRNL Owner (Exploit Injector)"; break;
                            default: reason = `Banned for exploiting by ${entry.BannedBy} group`; break;
                        }
                        bans.push({ source: "OOFD Federation", reason: reason, date: new Date().toISOString(), isExploit: true });
                    });
                }
                return bans;
            } catch (e) { return []; }
        }

        async function checkClanwareJustice(userId) {
            const hits = [];
            const checks = [
                { endpoint: '/api/justice/exploiters', type: 'EXPLOIT', label: 'Clanware Justice (Exploiter)' },
                { endpoint: '/api/justice/degenerates', type: 'CONDUCT', label: 'Clanware Justice (Degenerate)' }
            ];
            for (const check of checks) {
                try {
                    const r = await fetch(`${JUSTICE_PROXY}${check.endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ robloxIds: [String(userId)], showArchived: true })
                    });
                    if (r.ok) {
                        const data = await r.json();
                        if (Array.isArray(data) && data.length > 0) {
                            data.forEach(item => {
                                hits.push({ source: check.label, reason: `Case #${item.case_id} (${item.status})`, date: item.date_created || new Date().toISOString(), isExploit: check.type === 'EXPLOIT', isJustice: true, details: item });
                            });
                        }
                    }
                } catch (e) { }
            }
            return hits;
        }

        // --- NEW: EASI / ERP DETECTION CHECK ---
        async function checkEASI(userId) {
            if (!app.user || !app.token) return null; // Secure Guard

            try {
                log(`Querying EASI/ERP Database (Secure Proxy)...`, 'system');
                const r = await fetch(`${EASI_WORKER}/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${app.token}`
                    }
                });

                if (r.status === 404) {
                    return null; // Clean
                }

                if (r.ok) {
                    const data = await r.json();
                    if (data.is_erp === true) {
                        return {
                            isHit: true,
                            data: data,
                            source: "EASI/ERP Searcher"
                        };
                    }
                }
            } catch (e) {
                console.error("EASI Check Failed:", e);
            }
            return null;
        }

        // --- NEW: MOCO-CO CHECKER ---
        async function checkMococo(userId) {
            // UPDATED: No longer strict return null if not logged in.
            // We proceed, but only attach the token if it exists.
            
            const headers = {};
            if (app.user && app.token) {
                headers['Authorization'] = `Bearer ${app.token}`;
            }

            try {
                log(`Connecting to Moco-co group database...`, 'system');
                const r = await fetch(`${MOCOCO_WORKER}/${userId}`, {
                    headers: headers
                });

                if (r.ok) {
                    const data = await r.json();
                    return data;
                }
            } catch (e) {
                console.error("Moco-co Check Failed:", e);
                log('Moco-co Connection Failed', 'error');
            }
            return null;
        }


        async function fetchDiscordIntelligence(discordId) {
            log(`Parsing TASE Intelligence for Discord ID: ${discordId}...`, 'system');
            try {
                const [profileReq, taseReq] = await Promise.all([
                    fetch(`${TASE_WORKER}/discord/v10/users/${discordId}`),
                    fetch(`${TASE_WORKER}/api/v1/check/${discordId}`)
                ]);
                const profile = profileReq.ok ? await profileReq.json() : null;
                const tase = taseReq.ok ? await taseReq.json() : { scoreSum: 0, guilds: [] };
                return { profile, tase };
            } catch (e) { return null; }
        }

        function calculateDiscordRisk(tase) {
            const guilds = tase.guilds || [];
            const count = guilds.length;
            const score = tase.scoreSum || 0; // Display purpose only

            let rating = "SAFE";
            let color = "text-green-500";
            let barColor = "bg-green-500";
            let rBorder = "border-green-600";

            if (count > 1) {
                rating = "CRITICAL";
                color = "text-red-500";
                barColor = "bg-red-600";
                rBorder = "border-red-600";
            } else if (count === 1) {
                rating = "SUSPICIOUS";
                color = "text-yellow-500";
                barColor = "bg-yellow-500";
                rBorder = "border-yellow-500";
            }

            return { score, rating, color, barColor, rBorder, count };
        }

        async function checkFederatedBans(userId) {
            let hits = [];
            if (LOCAL_THREAT_IDS.includes(String(userId))) { hits.push({ source: "Local Threat List", reason: "Manually Flagged by Operator", date: new Date().toISOString() }); }
            const oofdBans = await checkOOFD(userId);
            hits = [...hits, ...oofdBans];
            const justiceBans = await checkClanwareJustice(userId);
            hits = [...hits, ...justiceBans];
            for (const db of EXTERNAL_DATABASES) {
                if (db.url) {
                    try {
                        const targetUrl = db.proxy ? `https://corsproxy.io/?${encodeURIComponent(db.url)}` : db.url;
                        const r = await fetch(targetUrl);
                        if (r.ok) {
                            const textData = await r.text();
                            const regex = new RegExp(`(?:^|[^0-9])${userId}(?:$|[^0-9])`);
                            if (regex.test(textData)) { hits.push({ source: db.name, reason: `Listed in ${db.name}`, date: new Date().toISOString() }); }
                        }
                    } catch (e) { }
                }
            }
            return hits;
        }

        // --- Core Search Logic (UPDATED FOR HISTORY/CACHE) ---
        async function search(query, isHistoryNav = false) {
            const q = query || document.getElementById('search-input').value.trim();
            if (!q) return;
            document.getElementById('search-input').value = q;

            // --- CACHE CHECK ---
            if (app.cache.has(q)) {
                console.log("Cache Hit for:", q);
                const cached = app.cache.get(q);

                // Restore State
                app.profile = cached.profile;
                app.friends = cached.friends;
                app.groups = cached.groups;
                app.bannedFriends = cached.bannedFriends;
                app.rings = cached.rings;
                app.rotector = cached.rotector;
                app.federatedBans = cached.federatedBans;
                app.discordData = cached.discordData;
                app.easiData = cached.easiData;
                app.mococoData = cached.mococoData; // Restore Moco-co
                app.identities = cached.identities || []; // Restore Identities
                app.friendStats = { ...cached.friendStats };

                // Update History State if not navigating
                if (!isHistoryNav) {
                    if (app.historyIndex < app.history.length - 1) {
                        app.history = app.history.slice(0, app.historyIndex + 1);
                    }
                    app.history.push(q);
                    app.historyIndex = app.history.length - 1;
                }
                updateNavButtons();

                // Instant Render
                document.getElementById('terminal').classList.add('hidden');
                renderDashboard(cached.rawData);
                // Re-run visual updates that aren't data dependent
                updateFriendStatsUI();
                return;
            }

            // --- NORMAL SEARCH ---
            // UI Reset
            document.getElementById('dashboard-container').innerHTML = '';
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('terminal').classList.remove('hidden');
            document.getElementById('logs').innerHTML = '';

            app.rotector = null;
            app.federatedBans = [];
            app.discordData = null;
            app.easiData = null;
            app.mococoData = null; // Reset Moco-co
            app.identities = []; // Reset Identities
            app.friendSafety.clear();
            app.friendStats = { unsafe: 0, flagged: 0, scanned: 0, total: 0, errors: 0 };

            log(`Initializing session...`);
            await new Promise(r => setTimeout(r, 100)); // Faster init
            log(`Target Identifier: ${q}`);
            log(`Connecting to SA-DB...`);

            try {
                const r = await fetch(`${DATA_WORKER}?lookup=${encodeURIComponent(q)}`);
                const d = await r.json();

                if (!d.success) {
                    const err = d.error || "Unknown Error";
                    if (err.includes("User not found")) {
                        log(`ERROR: User not found. Verify ID/Username.`, 'error');
                        return; // Stop execution
                    } else {
                        throw new Error(err);
                    }
                }

                log(`Data stream received.`, 'success');
                log(`Parsing threat vectors...`);

                app.profile = d.profile;
                app.friends = d.friends || [];
                app.groups = d.profile.groups || [];
                app.bannedFriends = d.bannedFriends || [];
                app.friendStats.total = app.friends.length;
                app.rings = d.ringIndicators || d.rings || [];

                // --- FEDERATED LISTS CHECK ---
                if (app.profile.id) {
                    log(`Querying Federated Ban Lists...`);
                    const fedBans = await checkFederatedBans(app.profile.id);
                    if (fedBans.length > 0) {
                        app.federatedBans = fedBans;
                        log(`MATCH FOUND: Subject listed in ${fedBans.length} database(s).`, 'error');
                    } else {
                        log(`Federated lists: Clean.`, 'success');
                    }
                }

                // --- EASI / ERP CHECK (Authenticated) ---
                if (app.profile.id && app.user && app.token) {
                    const easiResult = await checkEASI(app.profile.id);
                    if (easiResult) {
                        app.easiData = easiResult;
                        log(`EASI DETECTION CONFIRMED: High Risk ERP Markers found.`, 'error');
                    } else {
                        log(`EASI Database: Clean.`, 'success');
                    }

                    // --- NEW: FETCH LINKED IDENTITIES ---
                    log(`Querying Identity Atlas (Linker)...`, 'system');
                    try {
                        const lRes = await fetch(`${LINKER_WORKER}/lookup?platform=roblox&id=${app.profile.id}`, { headers: { 'Authorization': `Bearer ${app.token}` } });
                        console.log("Identity lookup response status:", lRes.status);
                        if (lRes.ok) {
                            const lData = await lRes.json();
                            console.log("Identity lookup data:", lData);
                            app.identities = lData.identities || [];
                            console.log("Parsed identities:", app.identities);
                            log(`Atlas: Found ${app.identities.length} linked identities.`, app.identities.length > 0 ? 'warn' : 'success');
                        } else {
                            const errText = await lRes.text();
                            console.error("Identity lookup error:", errText);
                        }
                    } catch (e) { console.warn("Linker fetch failed", e); }
                }

                // --- MOCO-CO CHECK (UPDATED) ---
                // Always check, regardless of auth status
                if (app.profile.id) {
                    const mococoResult = await checkMococo(app.profile.id);
                    if (mococoResult) {
                        app.mococoData = mococoResult;
                        
                        // NEW LOGIC: Integrate Hidden Groups if Authenticated
                        if (mococoResult.groups && Array.isArray(mococoResult.groups) && mococoResult.groups.length > 0) {
                            log(`MOCO-CO: ${mococoResult.groups.length} hidden group IDs found. Merging...`, 'warn');
                            
                            // Merge into main group list
                            mococoResult.groups.forEach(hiddenId => {
                                const existing = app.groups.find(g => String(g.id) === String(hiddenId));
                                if (existing) {
                                    existing.isRed = true; // Mark existing group
                                } else {
                                    // Add new "Hidden" group entry
                                    app.groups.unshift({
                                        id: hiddenId,
                                        name: `[Flagged Group ${hiddenId}]`,
                                        role: "Detected",
                                        isRed: true // Mark new group
                                    });
                                }
                            });
                        } else if (mococoResult.groupCount > 0) {
                             log(`Moco-co: User flagged in ${mococoResult.groupCount} group(s).`, 'warn');
                        } else {
                            log(`Moco-co: Subject monitored, clean record.`, 'success');
                        }
                    } else {
                        log(`Moco-co: Subject not tracked.`, 'info');
                    }
                }

                // --- ROTECTOR & DISCORD CHECK ---
                if (app.profile.id) {
                    try {
                        log(`Querying Rotector AI Safety Matrix...`);
                        const rotResponse = await fetch(`${ROTECTOR_API}/${app.profile.id}`);
                        if (rotResponse.ok) {
                            const rotData = await rotResponse.json();
                            if (rotData.success) {
                                app.rotector = rotData.data;
                                const flagType = app.rotector.flagType;
                                const logType = flagType === 2 ? "error" : flagType === 0 ? "success" : "warn";
                                log(`Rotector AI Analysis: ${flagType === 2 ? "UNSAFE" : flagType === 0 ? "SAFE" : "PENDING"}`, logType);

                                let foundDiscordId = null;
                                if (app.rotector.reasons) {
                                    Object.values(app.rotector.reasons).forEach(reason => {
                                        if (reason.evidence && Array.isArray(reason.evidence)) {
                                            reason.evidence.forEach(ev => {
                                                const match = ev.match(/Discord User ID:\s*(\d+)/i);
                                                if (match) foundDiscordId = match[1];
                                            });
                                        }
                                    });
                                }

                                if (foundDiscordId) {
                                    log(`EXTRACTED DISCORD ID: ${foundDiscordId}`, 'system');
                                    app.discordData = await fetchDiscordIntelligence(foundDiscordId);
                                    if (app.discordData && app.discordData.profile) {
                                        log(`Discord profile linked via TASE.`, 'success');
                                    }
                                }
                            }
                        }
                    } catch (e) { log(`Rotector/Discord AI connection timed out.`, 'warn'); }
                }

                // --- SAIKOU CHECK ---
                const saikouData = app.groups.find(g => String(g.id) === SAIKOU_GROUP_ID);
                if (saikouData) log(`SAIKOU AFFILIATION CONFIRMED: ${saikouData.role}`, 'success');

                const sdisData = app.groups.find(g => String(g.id) === SDIS_GROUP_ID);
                if (sdisData) log(`SDIS AGENT IDENTIFIED: ${sdisData.role}`, 'success');

                // Auth Worker (Rings)
                if (app.user) {
                    try {
                        log('Authenticating ring access...');
                        const rr = await fetch(`${AUTH_WORKER}/rings`, { headers: { 'Authorization': `Bearer ${app.token}` } });
                        const rd = await rr.json();
                        if (rd.success && rd.rings) {
                            app.userRings = rd.rings;
                            app.rings = rd.rings.filter(ring => ring.members && ring.members.some(m => String(m.userId) === String(app.profile.id)));
                            log('Ring vectors updated via SDIS.', 'success');
                        }
                    } catch (e) { }
                }

                // --- CACHE SAVE ---
                const cacheEntry = {
                    rawData: d,
                    profile: app.profile,
                    friends: app.friends,
                    groups: app.groups,
                    bannedFriends: app.bannedFriends,
                    rings: app.rings,
                    rotector: app.rotector,
                    federatedBans: app.federatedBans,
                    discordData: app.discordData,
                    easiData: app.easiData,
                    mococoData: app.mococoData,
                    identities: app.identities,
                    friendStats: app.friendStats,
                    timestamp: Date.now()
                };
                app.cache.set(q, cacheEntry);

                // History Logic
                if (!isHistoryNav) {
                    if (app.historyIndex < app.history.length - 1) {
                        app.history = app.history.slice(0, app.historyIndex + 1);
                    }
                    app.history.push(q);
                    app.historyIndex = app.history.length - 1;
                }
                updateNavButtons();

                renderDashboard(d);
            } catch (e) {
                console.error("MAIN SEARCH ERROR:", e);
                log(`FATAL: ${e.message}`, 'error');
            }
        }

        // --- Copy Link Function ---
        function copyProfileLink(btn, userId) {
            const url = `${window.location.origin}${window.location.pathname}?lookup=${userId}`;
            const textArea = document.createElement("textarea");
            textArea.value = url;
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (!successful) throw new Error("execCommand failed");
            } catch (err) {
                navigator.clipboard.writeText(url).catch(e => console.error("Clipboard failed", e));
            }
            document.body.removeChild(textArea);
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-check mr-2 w-4 text-center text-green-500"></i> <span class="text-green-500 font-bold">Copied!</span>`;
            setTimeout(() => { btn.innerHTML = originalContent; }, 2000);
        }

        // --- Helper: Saikou Rank Styler ---
        function getSaikouRankStyle(role) {
            const r = role.toLowerCase();
            if (r.includes('lead developer')) return { text: 'text-fuchsia-400', border: 'border-fuchsia-500/50', bg: 'bg-fuchsia-950/30', icon: 'fa-code', shadow: 'shadow-fuchsia-500/20', glow: 'shadow-[0_0_20px_rgba(232,121,249,0.15)]' };
            if (r.includes('community manager')) return { text: 'text-emerald-400', border: 'border-emerald-500/50', bg: 'bg-emerald-950/30', icon: 'fa-bullhorn', shadow: 'shadow-emerald-500/20', glow: 'shadow-[0_0_20px_rgba(52,211,153,0.15)]' };
            if (r.includes('head moderator')) return { text: 'text-red-500', border: 'border-red-500/50', bg: 'bg-red-950/30', icon: 'fa-gavel', shadow: 'shadow-red-500/20', glow: 'shadow-[0_0_20px_rgba(239,68,68,0.15)]' };
            if (r.includes('senior moderator')) return { text: 'text-orange-400', border: 'border-orange-500/50', bg: 'bg-orange-950/30', icon: 'fa-shield-alt', shadow: 'shadow-orange-500/20', glow: 'shadow-[0_0_20px_rgba(251,146,60,0.15)]' };
            if (r.includes('moderator')) return { text: 'text-blue-400', border: 'border-blue-500/50', bg: 'bg-blue-950/30', icon: 'fa-shield-alt', shadow: 'shadow-blue-500/20', glow: 'shadow-[0_0_20px_rgba(96,165,250,0.15)]' };
            if (r.includes('trial moderator')) return { text: 'text-cyan-400', border: 'border-cyan-500/50', bg: 'bg-cyan-950/30', icon: 'fa-graduation-cap', shadow: 'shadow-cyan-500/20', glow: 'shadow-[0_0_20px_rgba(34,211,238,0.15)]' };
            if (r.includes('contractor')) return { text: 'text-yellow-400', border: 'border-yellow-500/50', bg: 'bg-yellow-950/30', icon: 'fa-file-contract', shadow: 'shadow-yellow-500/20', glow: 'shadow-[0_0_20px_rgba(250,204,21,0.15)]' };
            return { text: 'text-gray-400', border: 'border-gray-600', bg: 'bg-[#111]', icon: 'fa-user', shadow: 'shadow-gray-500/20', glow: 'shadow-none' };
        }

        // --- Batch Friend Safety Check ---
        async function batchCheckFriends() {
            const friendIds = app.friends.map(f => parseInt(f.id, 10)).filter(id => !isNaN(id) && id > 0);
            if (friendIds.length === 0) return;
            const BATCH_SIZE = 100;
            const statusEl = document.getElementById('friend-scan-status');

            // Only reset if stats are 0 (fresh search)
            if (app.friendStats.total === 0) app.friendStats = { unsafe: 0, flagged: 0, scanned: 0, total: friendIds.length, errors: 0 };

            for (let i = 0; i < friendIds.length; i += BATCH_SIZE) {
                const batch = friendIds.slice(i, i + BATCH_SIZE);
                // Check if we already have data for this batch to avoid re-fetching on cache restore
                const needsFetch = batch.some(id => !app.friendSafety.has(String(id)));

                if (!needsFetch) {
                    app.friendStats.scanned += batch.length; // Just update progress count
                } else {
                    if (statusEl) {
                        const percent = Math.min(100, Math.round(((i) / friendIds.length) * 100));
                        statusEl.innerHTML = `<i class="fas fa-sync fa-spin text-xs"></i> Scanning ${percent}%`;
                    }
                    try {
                        const response = await fetch(ROTECTOR_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ids: batch }) });
                        if (!response.ok) throw new Error("API Error");
                        const data = await response.json();
                        if (data.success && data.data) {
                            Object.values(data.data).forEach(user => {
                                app.friendSafety.set(String(user.id), user);
                                if (user.flagType === 2) app.friendStats.unsafe++;
                                if (user.flagType > 0) app.friendStats.flagged++;
                            });
                            app.friendStats.scanned += batch.length;
                        }
                    } catch (e) { app.friendStats.errors++; }
                }
                updateFriendGrid();
                updateFriendStatsUI();
                await new Promise(r => setTimeout(r, 300));
            }
            if (statusEl) statusEl.innerHTML = app.friendStats.errors > 0 ? `<span class="text-red-500">Scan Errors</span>` : `<span class="text-gray-500">Scan Complete</span>`;
            updateFriendStatsUI();
        }

        function updateFriendStatsUI() {
            const el = document.getElementById('friend-stats-display');
            if (!el) return;
            if (app.friendStats.errors > 0) el.innerHTML = `<span class="text-red-500 font-bold"><i class="fas fa-exclamation-circle"></i> Errors (${app.friendStats.errors})</span>`;
            else if (app.friendStats.unsafe > 0) el.innerHTML = `<span class="text-red-500 font-bold animate-pulse"><i class="fas fa-exclamation-triangle"></i> ${app.friendStats.unsafe} Unsafe</span>`;
            else if (app.friendStats.flagged > 0) el.innerHTML = `<span class="text-yellow-500 font-bold"><i class="fas fa-flag"></i> ${app.friendStats.flagged} Flagged</span>`;
            else if (app.friendStats.scanned >= app.friendStats.total && app.friendStats.total > 0) el.innerHTML = `<span class="text-green-500"><i class="fas fa-check"></i> Clean</span>`;
            else el.innerHTML = `<span class="text-gray-500">${app.friendStats.scanned}/${app.friendStats.total} Scanned</span>`;
        }

        // --- VERIFY LINK LOGIC (Atlas Integration) ---
        function resetVerify() {
            document.getElementById('verify-preview').classList.add('hidden');
            const btn = document.getElementById('btn-submit-link');
            btn.textContent = "Add Link"; btn.disabled = true;
            app.linkVerifiedData = null;
        }

        async function verifyLinkSubject() {
            const platform = document.getElementById('link-platform-select').value;
            const rawId = document.getElementById('link-id').value.trim();
            if (!rawId) return;

            const vBtn = document.getElementById('btn-verify-link');
            const origHTML = vBtn.innerHTML;
            vBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                let resolvedId = rawId;
                let username = "Unknown";
                let avatarUrl = "";

                if (platform === 'roblox') {
                    if (isNaN(rawId)) {
                        const res = await fetch(`https://corsproxy.io/?https://users.roblox.com/v1/usernames/users`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ usernames: [rawId], excludeBannedUsers: false }) });
                        const data = await res.json();
                        if (data.data && data.data.length > 0) { resolvedId = data.data[0].id.toString(); username = data.data[0].name; }
                        else throw new Error("Roblox user not found");
                    } else {
                        const res = await fetch(`https://corsproxy.io/?https://users.roblox.com/v1/users/${rawId}`);
                        const data = await res.json();
                        if (data.name) { username = data.name; resolvedId = rawId; } else throw new Error("Roblox ID invalid");
                    }
                    avatarUrl = await getAvatar(resolvedId, username);

                } else if (platform === 'discord') {
                    if (isNaN(rawId)) throw new Error("Discord requires Numeric ID");
                    const dData = await resolveDiscordData(rawId);
                    if(dData.username === "Unknown Discord User") throw new Error("Discord ID not found");
                    
                    username = dData.username;
                    resolvedId = rawId;
                    avatarUrl = dData.avatarUrl;

                } else { username = "External User"; }

                document.getElementById('verify-img').src = avatarUrl || 'https://placehold.co/100x100/333/FFF?text=?';
                document.getElementById('verify-name').textContent = username;
                document.getElementById('verify-id').textContent = `ID: ${resolvedId}`;
                document.getElementById('verify-preview').classList.remove('hidden');

                const linkBtn = document.getElementById('btn-submit-link');
                linkBtn.disabled = false;
                app.linkVerifiedData = { platform, id: resolvedId, username };

            } catch (e) { alert("Verification Failed: " + e.message); resetVerify(); }
            vBtn.innerHTML = origHTML;
        }

        async function submitLink() {
            if (!app.token || !app.linkVerifiedData) return;
            const confidence = document.getElementById('link-confidence-select').value;
            const { platform, id, username } = app.linkVerifiedData;
            const btn = document.getElementById('btn-submit-link');
            btn.textContent = "Linking..."; btn.disabled = true;

            try {
                console.log("Starting link process...");
                console.log("Current profile ID:", app.profile.id);
                console.log("Linking:", { platform, id, confidence });
                
                // Step 1: Initialize anchor profile for current user
                const initPayload = {
                    platform: 'roblox',
                    platformId: String(app.profile.id),
                    confidence: 'CERTAIN',
                    targetProfileId: null
                };
                console.log("Init payload:", initPayload);
                
                const initRes = await fetch(`${LINKER_WORKER}/link`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${app.token}` },
                    body: JSON.stringify(initPayload)
                });

                console.log("Init response status:", initRes.status);
                if (!initRes.ok) {
                    const errData = await initRes.text();
                    console.error("Init error response:", errData);
                    throw new Error(`Failed to initialize anchor profile: ${errData}`);
                }
                const initData = await initRes.json();
                console.log("Init response data:", initData);
                const anchorUUID = initData.profile_id;
                console.log("Anchor UUID:", anchorUUID);

                // Step 2: Link the Alt to the Anchor UUID
                const linkPayload = {
                    platform: platform,
                    platformId: String(id),
                    confidence: confidence,
                    targetProfileId: anchorUUID
                };
                console.log("Link payload:", linkPayload);
                
                const linkRes = await fetch(`${LINKER_WORKER}/link`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${app.token}` },
                    body: JSON.stringify(linkPayload)
                });

                console.log("Link response status:", linkRes.status);
                const linkData = await linkRes.json();
                console.log("Link response data:", linkData);
                
                // Check if response contains an error even with 200 status
                if (linkData.error) {
                    // Check if it's a conflict that requires merging
                    if (linkData.conflict && linkData.existing_profile_id && linkData.target_profile_id) {
                        console.log("Conflict detected - profiles need to be merged");
                        
                        // Store merge data for the modal
                        app.pendingMerge = {
                            platform: platform,
                            platformId: id,
                            existingProfileId: linkData.existing_profile_id,
                            targetProfileId: linkData.target_profile_id
                        };
                        
                        // Populate and show custom merge modal
                        document.getElementById('merge-platform').textContent = platform.charAt(0).toUpperCase() + platform.slice(1);
                        document.getElementById('merge-current-profile').textContent = `${app.profile.name} (${app.profile.id})`;
                        document.getElementById('merge-linking-account').textContent = `${platform}: ${id}`;
                        
                        closeModals();
                        toggleModal('modal-merge-confirm');
                        
                        btn.textContent = "Add Link";
                        btn.disabled = false;
                        return;
                    }
                    
                    // Check if it's already linked to this profile
                    if (linkData.error.includes("already linked")) {
                        const alreadyExists = app.identities.some(i => 
                            i.platform === platform && String(i.platform_id) === String(id)
                        );
                        if (alreadyExists) {
                            throw new Error("This account is already linked to this profile.");
                        }
                    }
                    
                    throw new Error(linkData.error);
                }
                
                if (!linkRes.ok) {
                    throw new Error(`Failed to link alt identity: ${linkData.message || 'Unknown error'}`);
                }

                // Add the new identity to the app state
                const newIdentity = {
                    platform: platform,
                    platform_id: String(id),
                    confidence: confidence
                };
                app.identities.push(newIdentity);

                // Clear cache so next search gets fresh data
                app.cache.delete(String(app.profile.id));

                closeModals();
                resetVerify();
                document.getElementById('link-id').value = '';
                
                // Just re-render the identity panel without full refresh
                const identityContainer = document.querySelector('.min-panel.border-l-2.border-gray-600');
                if (identityContainer) {
                    const alts = app.identities.filter(i => !(i.platform === 'roblox' && String(i.platform_id) === String(app.profile.id)));
                    
                    identityContainer.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                             <h3 class="text-sm font-bold text-white uppercase flex items-center gap-2">
                                 <i class="fas fa-link text-gray-500"></i> Linked Accounts
                             </h3>
                             <button onclick="toggleModal('modal-add-link')" class="text-xs text-gray-400 hover:text-white transition-colors border border-gray-700 px-2 py-0.5 rounded hover:bg-gray-800"><i class="fas fa-plus mr-1"></i>Add</button>
                        </div>
                        
                        ${alts.length > 0 ? `
                            <div class="space-y-2 max-h-60 overflow-y-auto custom-scroll pr-1">
                                ${alts.map(alt => {
                                    const confColor = alt.confidence === 'CERTAIN' ? 'text-green-400 border-green-900 bg-green-900/10' : alt.confidence === 'LIKELY' ? 'text-yellow-400 border-yellow-900 bg-yellow-900/10' : 'text-gray-400 border-gray-800';
                                    // Keep ID as string to avoid floating point precision loss with large Discord IDs
                                    const cleanId = String(alt.platform_id).trim();
                                    const imgId = `linked-img-${alt.platform}-${cleanId}`;
                                    const nameId = `linked-name-${alt.platform}-${cleanId}`;
                                    const profileLink = alt.platform === 'roblox' ? `https://www.roblox.com/users/${cleanId}/profile` : '#';
                                    const copyAction = alt.platform === 'discord' ? `onclick="navigator.clipboard.writeText('${cleanId}')"` : '';
                                    const platformIcon = alt.platform === 'discord' ? 'fab fa-discord' : alt.platform === 'roblox' ? 'fas fa-user' : 'fas fa-link';
                                    const platformColor = alt.platform === 'discord' ? 'text-[#5865F2]' : 'text-gray-500';
                                    
                                    const cardId = `link-card-${alt.platform}-${cleanId}`;
                                    return `
                                    <div id="${cardId}" class="linked-account-card border border-[#333] bg-[#050505] rounded transition-colors" onclick="toggleLinkCard('${cardId}', event)">
                                        <div class="flex items-center justify-between p-2">
                                            <div class="flex items-center gap-3 min-w-0 flex-1">
                                                <div class="relative">
                                                    <img id="${imgId}" src="https://placehold.co/40x40/111/444?text=..." class="w-8 h-8 rounded bg-[#111] border border-[#333] object-cover flex-shrink-0">
                                                    <i class="${platformIcon} ${platformColor} absolute -bottom-0.5 -right-0.5 text-[10px] bg-black rounded-full p-0.5 border border-[#333]"></i>
                                                </div>
                                                <div class="min-w-0 flex-1">
                                                    <div id="${nameId}" class="text-xs font-bold text-gray-200 truncate">Loading...</div>
                                                    <div class="flex items-center gap-1.5">
                                                        <div class="text-[9px] text-gray-500 uppercase font-bold tracking-wider">${alt.platform}</div>
                                                        <div class="w-0.5 h-0.5 bg-gray-700 rounded-full"></div>
                                                        <a href="${profileLink}" target="_blank" ${copyAction} class="text-[9px] text-gray-600 font-mono hover:text-gray-400 transition-colors" title="${cleanId}" onclick="event.stopPropagation()">${cleanId}</a>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="text-[9px] font-bold px-1.5 py-0.5 rounded border ${confColor}">${alt.confidence}</div>
                                                <i class="fas fa-chevron-down text-gray-500 text-xs expand-indicator"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="linked-account-details px-2 pb-2">
                                            <div class="border-t border-[#222] pt-3 space-y-2">
                                                <div class="grid grid-cols-2 gap-2 text-xs">
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-500">Confidence:</span>
                                                        <span class="font-bold ${confColor.split(' ')[0]}">${alt.confidence}</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-500">Platform:</span>
                                                        <span class="text-white uppercase">${alt.platform}</span>
                                                    </div>
                                                </div>
                                                <div class="flex items-center justify-between pt-2">
                                                    <a href="${profileLink}" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 transition-colors" onclick="event.stopPropagation()">
                                                        <i class="fas fa-external-link-alt mr-1"></i>View Profile
                                                    </a>
                                                    <button onclick="confirmDeleteLink('${alt.platform}', '${cleanId}'); event.stopPropagation();" class="text-xs text-red-500 hover:text-red-400 transition-colors px-2 py-1 border border-red-900/30 rounded hover:bg-red-900/10">
                                                        <i class="fas fa-unlink mr-1"></i>Remove Link
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `<div class="text-xs text-gray-500 italic p-2 text-center">No linked identities found.</div>`}
                    `;
                    
                    // Hydrate the new cards
                    hydrateLinkedAccounts(alts);
                }

            } catch (e) { 
                console.error("Submit link error:", e);
                alert(`Error: ${e.message}`); 
                btn.textContent = "Add Link"; 
                btn.disabled = false; 
            }
        }

        async function fetchPOIDetails(userId) {
            if (!app.token) { document.getElementById('poi-login-msg')?.classList.remove('hidden'); return; }
            document.getElementById('poi-data-container')?.classList.remove('hidden');
            try {
                const response = await fetch(`${DATA_WORKER}/poi/${userId}`, { headers: { 'Authorization': `Bearer ${app.token}` } });
                const result = await response.json();
                if (result.success && result.data) {
                    document.getElementById('poi-marker').textContent = result.data.markedBy || 'Unknown';
                    document.getElementById('poi-reason-text').textContent = result.data.reason || 'No reason provided.';
                    document.getElementById('poi-date').textContent = result.data.timestamp ? new Date(result.data.timestamp).toLocaleDateString() : 'Unknown';
                }
            } catch (e) { document.getElementById('poi-reason-text').textContent = "Connection failed."; }
        }

        // --- NEW: Client-Side Group Analysis Fetcher ---
        async function loadGroupAnalysis(groupIds) {
            const container = document.getElementById('hidden-group-analysis-content');
            if (!container) return;

            container.innerHTML = '<div class="text-xs text-gray-500 animate-pulse"><i class="fas fa-satellite-dish mr-2"></i>Interrogating Roblox API endpoints...</div>';

            const results = [];
            
            // Fetch in parallel
            await Promise.all(groupIds.map(async (gid) => {
                try {
                    // Use CORS proxy to hit Roblox API directly from client (User IP)
                    const proxyBase = "https://corsproxy.io/?";
                    const infoUrl = `${proxyBase}${encodeURIComponent(`https://groups.roblox.com/v1/groups/${gid}`)}`;
                    const thumbUrl = `${proxyBase}${encodeURIComponent(`https://thumbnails.roblox.com/v1/groups/icons?groupIds=${gid}&size=150x150&format=Png&isCircular=false`)}`;
                    
                    const [infoReq, thumbReq] = await Promise.all([
                        fetch(infoUrl),
                        fetch(thumbUrl)
                    ]);

                    if (infoReq.ok) {
                        const infoData = await infoReq.json();
                        let iconUrl = null;
                        
                        if (thumbReq.ok) {
                            const thumbData = await thumbReq.json();
                            if (thumbData.data && thumbData.data.length > 0) {
                                iconUrl = thumbData.data[0].imageUrl;
                            }
                        }
                        
                        // Attach icon to data object
                        infoData.iconUrl = iconUrl;
                        results.push(infoData);
                    }
                } catch (e) {
                    console.error(`Failed to fetch group ${gid}`, e);
                }
            }));

            if (results.length === 0) {
                container.innerHTML = '<div class="text-xs text-red-400">Failed to retrieve group details. Proxies may be busy.</div>';
                return;
            }

            container.innerHTML = results.map(g => {
                const created = new Date(g.created).toLocaleDateString();
                // Safe description truncation
                const desc = g.description ? (g.description.length > 100 ? g.description.substring(0, 100) + '...' : g.description) : 'No description.';
                
                return `
                <div class="bg-[#050505] border border-red-900/30 rounded p-3 mb-2 flex gap-3 hover:border-red-500/50 transition-colors">
                    <div class="flex-shrink-0">
                        <img src="${g.iconUrl || 'https://placehold.co/150x150/330000/FFF?text=GRP'}" 
                             class="w-12 h-12 rounded bg-[#111] object-cover border border-[#333]">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h4 class="text-sm font-bold text-red-200 truncate"><a href="https://www.roblox.com/groups/${g.id}" target="_blank" class="hover:underline">${g.name}</a></h4>
                            <span class="text-[9px] bg-[#222] text-gray-400 px-1.5 py-0.5 rounded border border-[#333]">${g.memberCount} Members</span>
                        </div>
                        <div class="text-[10px] text-gray-500 font-mono mb-1">
                            ID: ${g.id} <span class="mx-1">|</span> Owner: <a href="https://www.roblox.com/users/${g.owner?.userId}/profile" target="_blank" class="hover:text-white">${g.owner?.username || 'None'}</a>
                        </div>
                        <p class="text-[10px] text-gray-400 italic leading-tight break-words border-l-2 border-[#333] pl-2">${escapeHtml(desc)}</p>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- Dashboard Rendering ---
        function renderDashboard(data) {
            document.getElementById('terminal').classList.add('hidden');
            const container = document.getElementById('dashboard-container');
            container.classList.remove('hidden');

            const p = data.profile;
            // Pass Moco-co data to calculation
            const risk = calculateSafetyScore(p, app.friends, app.rings, app.bannedFriends, app.rotector, app.federatedBans, app.easiData, app.mococoData);

            // Saikou Check
            const saikouData = app.groups.find(g => String(g.id) === SAIKOU_GROUP_ID);
            let saikouBadgeHTML = '';
            if (saikouData) {
                const style = getSaikouRankStyle(saikouData.role);
                saikouBadgeHTML = `
                    <div class="mt-4 p-4 rounded-lg border ${style.border} ${style.bg} ${style.glow} relative overflow-hidden group transition-all duration-300 hover:scale-[1.02]">
                        <div class="absolute -right-2 -bottom-4 text-9xl opacity-5 pointer-events-none select-none"><i class="fas ${style.icon} ${style.text}"></i></div>
                        <div class="flex items-center gap-4 relative z-10">
                            <div class="w-10 h-10 rounded-full ${style.bg} border ${style.border} flex items-center justify-center shadow-lg relative overflow-hidden">
                                 <div class="absolute inset-0 ${style.bg} animate-pulse opacity-50"></div>
                                 <i class="fas ${style.icon} ${style.text} text-lg relative z-10"></i>
                            </div>
                            <div>
                                <div class="text-[9px] uppercase font-bold text-gray-500 tracking-[0.2em] mb-0.5">Official Affiliation</div>
                                <div class="text-base font-black ${style.text} tracking-tight">${saikouData.role}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            const sdisData = app.groups.find(g => String(g.id) === SDIS_GROUP_ID);
            const sdisNameBadge = sdisData ? `<span class="ml-2 inline-flex items-center justify-center px-2 py-0 rounded-md bg-slate-900 border border-slate-600 text-slate-300 text-[10px] font-['Montserrat'] font-bold tracking-wider shadow-[0_0_10px_rgba(71,85,105,0.3)] align-middle" title="SDIS Agent // Verified">SDIS</span>` : '';

            let banHistory = data.banHistory || [];
            if (app.federatedBans.length > 0) {
                const fedBanRecords = app.federatedBans.map(fb => ({
                    Reason: fb.reason,
                    type: fb.isExploit ? "EXPLOIT" : fb.isJustice ? "JUSTICE" : "EXTERNAL",
                    Date: fb.date,
                    Moderator: fb.source,
                    details: fb.details
                }));
                banHistory = [...fedBanRecords, ...banHistory];
            }

            let rColor = "text-green-500"; let rBorder = "border-white";
            if (risk.rating === 'Unsafe') { rColor = "text-red-500"; rBorder = "border-red-600"; }
            else if (risk.rating === 'Caution') { rColor = "text-yellow-500"; rBorder = "border-yellow-500"; }

            // --- Discord Panel Logic ---
            let discordPanel = '';
            if (app.discordData && app.discordData.profile) {
                const dp = app.discordData.profile;
                const dt = app.discordData.tase || { scoreSum: 0, guilds: [] };
                const drisk = calculateDiscordRisk(dt);
                const avatar = dp.avatar ? `https://cdn.discordapp.com/avatars/${dp.id}/${dp.avatar}.png?size=64` : `https://cdn.discordapp.com/embed/avatars/0.png`;

                function formatSnowflake(id) {
                    if (!id) return new Date();
                    const timestamp = (BigInt(id) >> 22n) + 1420070400000n;
                    return new Date(Number(timestamp));
                }
                const createdDate = formatSnowflake(dp.id);

                discordPanel = `
                    <div class="min-panel p-5 border-l-2 ${drisk.rBorder} bg-[#0e0e11] mt-6">
                         <div class="flex justify-between items-center mb-4 border-b border-[#222] pb-2">
                             <div class="flex items-center gap-2">
                                 <i class="fab fa-discord text-[#5865F2] text-lg"></i>
                                 <h3 class="text-sm font-bold text-white uppercase">Discord Analysis</h3>
                             </div>
                             <span class="text-xs font-mono px-2 py-0.5 rounded bg-[#111] border border-[#333] ${drisk.color}">${drisk.rating}</span>
                         </div>
                         
                         <div class="flex items-center gap-4 mb-4">
                             <img src="${avatar}" class="w-12 h-12 rounded-full border-2 border-[#222]">
                             <div>
                                 <div class="text-white font-bold text-sm">${dp.global_name || dp.username}</div>
                                 <div class="text-xs text-gray-500 font-mono">ID: ${dp.id}</div>
                                 <div class="text-[10px] text-gray-600 font-mono mt-0.5">Created: ${createdDate.toLocaleDateString()}</div>
                             </div>
                             <div class="ml-auto text-right">
                                 <div class="text-xl font-black ${drisk.color}">${dt.scoreSum}</div>
                                 <div class="text-[9px] text-gray-600 uppercase">Score</div>
                             </div>
                         </div>

                         ${dt.guilds && dt.guilds.length > 0 ? `
                             <div class="text-[10px] uppercase text-gray-500 font-bold mb-2">Detected Connections</div>
                             <div class="space-y-2 max-h-60 overflow-y-auto custom-scroll pr-1">
                                 ${dt.guilds.map(g => `
                                     <div class="bg-[#050505] rounded border border-[#222] p-2 transition-colors hover:border-[#333]">
                                         <div class="flex justify-between items-start mb-2">
                                            <div class="min-w-0 flex-1 mr-2">
                                                <div class="flex items-center gap-2 mb-0.5">
                                                    <div class="text-xs font-bold text-gray-200 truncate" title="${g.name}">${g.name}</div>
                                                    ${g.detectedWith && g.detectedWith.length > 0 ?
                        `<span class="text-[8px] bg-[#1a1a1a] text-gray-500 px-1 rounded border border-[#333] font-mono tracking-tight">TASE ${g.detectedWith.map(v => `v${v}`).join(',')}</span>`
                        : ''}
                                                </div>
                                                <div class="flex flex-wrap items-center gap-2">
                                                    <span class="text-[8px] text-gray-600 uppercase font-bold tracking-widest">${g.type || 'UNKNOWN'}</span>
                                                    ${g.isStaff ? '<span class="text-[8px] bg-red-900/20 text-red-400 px-1 rounded border border-red-900/30 font-bold uppercase tracking-wider">Staff</span>' : ''}
                                                    ${g.isBooster ? '<span class="text-[8px] bg-pink-900/20 text-pink-400 px-1 rounded border border-pink-900/30 font-bold uppercase tracking-wider"><i class="fas fa-gem mr-0.5"></i>Booster</span>' : ''}
                                                </div>
                                            </div>
                                            <div class="text-right flex-shrink-0">
                                                <span class="text-xs font-mono font-bold text-red-500">+${g.score}</span>
                                            </div>
                                         </div>
                                         
                                         ${g.detail ? `
                                            <div class="grid grid-cols-4 gap-px bg-[#222] rounded overflow-hidden border border-[#222]">
                                                <div class="bg-[#0a0a0a] py-1 text-center group hover:bg-[#111] transition-colors">
                                                    <div class="text-[7px] text-gray-600 uppercase font-bold group-hover:text-gray-500">MSG</div>
                                                    <div class="text-[10px] font-mono text-gray-300 font-bold">${g.detail.messages || 0}</div>
                                                </div>
                                                <div class="bg-[#0a0a0a] py-1 text-center group hover:bg-[#111] transition-colors">
                                                    <div class="text-[7px] text-gray-600 uppercase font-bold group-hover:text-gray-500">TYPE</div>
                                                    <div class="text-[10px] font-mono text-gray-300 font-bold">${g.detail.typing || 0}</div>
                                                </div>
                                                <div class="bg-[#0a0a0a] py-1 text-center group hover:bg-[#111] transition-colors">
                                                    <div class="text-[7px] text-gray-600 uppercase font-bold group-hover:text-gray-500">INT</div>
                                                    <div class="text-[10px] font-mono text-gray-300 font-bold">${g.detail.interaction || 0}</div>
                                                </div>
                                                <div class="bg-[#0a0a0a] py-1 text-center group hover:bg-[#111] transition-colors">
                                                    <div class="text-[7px] text-gray-600 uppercase font-bold group-hover:text-gray-500">IND</div>
                                                    <div class="text-[10px] font-mono text-gray-300 font-bold">${g.detail.indirect || 0}</div>
                                                </div>
                                            </div>
                                         ` : ''}
                                     </div>
                                 `).join('')}
                             </div>
                         ` : '<div class="text-xs text-green-500 italic"><i class="fas fa-check-circle mr-1"></i> No adverse server connections found.</div>'}
                    </div>
                `;
            }

            // --- MOCO-CO PANEL (NEW) ---
            let mococoPanel = '';
            // Only show detailed panel if logged in AND hidden groups found
            if (app.mococoData && app.mococoData.groups && app.mococoData.groups.length > 0) {
                mococoPanel = `
                    <div class="min-panel p-5 border-l-2 border-red-500 bg-[#0e0e11] mt-6">
                        <div class="flex justify-between items-center mb-4 border-b border-[#222] pb-2">
                             <div class="flex items-center gap-2">
                                 <img src="https://cdn.simpleicons.org/roblox/ef4444" class="w-5 h-5">
                                 <h3 class="text-sm font-bold text-white uppercase">Group Analysis</h3>
                             </div>
                             <span class="text-xs font-mono px-2 py-0.5 rounded bg-red-900/20 text-red-400 border border-red-900/50">HIGH RISK GROUPS</span>
                         </div>
                         
                         <div id="hidden-group-analysis-content" class="max-h-80 overflow-y-auto custom-scroll pr-1">
                            <!-- Populated via JS -->
                         </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- LEFT COLUMN: Identity -->
                    <div class="space-y-6">
                        <div class="min-panel p-6 text-center relative ${p.isPOI ? 'poi-border border-2' : ''}">
                            <div class="absolute top-4 right-4 group">
                                <button class="text-gray-500 hover:text-white p-2"><i class="fas fa-ellipsis-v"></i></button>
                                <div class="hidden group-hover:block absolute right-0 mt-0 w-48 bg-[#111] border border-[#333] rounded z-10 text-left text-sm shadow-xl">
                                    <button onclick="copyProfileLink(this, '${p.id}')" class="block w-full text-left px-4 py-3 text-gray-300 hover:bg-[#222] hover:text-white transition-colors"><i class="fas fa-share-alt mr-2 w-4 text-center"></i> Copy Link</button>
                                    <div class="h-px bg-[#222]"></div>
                                    ${app.user ? `
                                        <button onclick="openRingModal('add')" class="block w-full text-left px-4 py-3 text-gray-300 hover:bg-[#222] hover:text-white transition-colors"><i class="fas fa-plus-circle mr-2 w-4 text-center"></i> Add to Ring</button>
                                        <button onclick="openRingModal('remove')" class="block w-full text-left px-4 py-3 text-gray-300 hover:bg-[#222] hover:text-white transition-colors"><i class="fas fa-minus-circle mr-2 w-4 text-center"></i> Remove Ring</button>
                                        <div class="h-px bg-[#222]"></div>
                                        ${!p.isPOI ? `<button onclick="toggleModal('modal-poi')" class="block w-full text-left px-4 py-3 text-red-400 hover:bg-red-900/20 transition-colors"><i class="fas fa-exclamation-triangle mr-2 w-4 text-center"></i> Mark POI</button>`
                        : `<button onclick="unmarkPoi()" class="block w-full text-left px-4 py-3 text-green-400 hover:bg-green-900/20 transition-colors"><i class="fas fa-check mr-2 w-4 text-center"></i> Unmark POI</button>`}
                                    ` : '<div class="px-4 py-3 text-[10px] text-gray-600 uppercase text-center">Login for actions</div>'}
                                </div>
                            </div>

                            <div class="relative inline-block mb-4">
                                <img src="${p.avatarUrl}" class="w-32 h-32 rounded-full border-2 border-[#333] bg-gray-900 object-cover" data-uid="${p.id}">
                                ${p.isBanned ? '<div class="absolute bottom-0 right-0 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow border border-black">BANNED</div>' : ''}
                            </div>
                            
                            <h2 class="text-xl font-bold text-white flex items-center justify-center flex-wrap">${p.displayName}${sdisNameBadge}</h2>
                            <p class="text-sm text-gray-500 font-mono mb-6">@${p.name} <span class="mx-1">|</span> ID: ${p.id}</p>
                            
                            ${saikouBadgeHTML}

                            ${p.isPOI ? `
                                <div class="poi-alert-card mb-6 text-left relative overflow-hidden mt-4">
                                    <div class="flex items-start gap-4">
                                        <i class="fas fa-exclamation-triangle text-red-500 text-3xl mt-1"></i>
                                        <div class="w-full">
                                            <h3 class="text-xl font-bold text-red-400 uppercase tracking-wider">Person of Interest</h3>
                                            <p class="text-xs text-gray-300 mb-3 leading-tight">This user has been flagged by SDIS. Exercise extreme caution.</p>
                                            <div id="poi-data-container" class="hidden space-y-3 pt-3 border-t border-red-500/30">
                                                <div><div class="text-[10px] uppercase text-red-400/70 font-bold mb-1">Reason</div><div id="poi-reason-text" class="text-xs text-gray-200 bg-red-950/40 p-2 rounded border border-red-900/50 font-mono leading-relaxed">Loading...</div></div>
                                                <div class="flex justify-between items-end text-[10px] font-mono text-gray-400"><div><div class="flex items-center gap-1"><i class="fas fa-user-shield"></i> <span id="poi-marker">...</span></div><div class="flex items-center gap-1 mt-0.5"><i class="fas fa-calendar"></i> <span id="poi-date">...</span></div></div>${app.user ? `<button onclick="unmarkPoi()" class="text-red-500 hover:text-white hover:underline">Revoke</button>` : ''}</div>
                                            </div>
                                            <div id="poi-login-msg" class="hidden text-xs text-red-300 bg-red-900/20 p-2 rounded border border-red-800/50 mt-2 flex items-center gap-2"><i class="fas fa-lock"></i> Restricted Dossier - Login to View Details</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            <div class="flex justify-center gap-2 mb-6 mt-6">
                                <a href="https://www.roblox.com/users/${p.id}/profile" target="_blank" class="min-btn-outline text-xs"><i class="fas fa-external-link-alt mr-1"></i> Roblox</a>
                                <button onclick="navigator.clipboard.writeText('${p.id}')" class="min-btn-outline text-xs"><i class="fas fa-copy mr-1"></i> ID</button>
                            </div>

                            <div class="grid grid-cols-3 gap-2 pt-6 border-t border-[#333]">
                                <div><div class="font-bold text-white text-lg">${formatNumber(p.friendCount)}</div><div class="text-[10px] text-gray-600 uppercase">Friends</div></div>
                                <div><div class="font-bold text-white text-lg">${formatNumber(p.groupCount)}</div><div class="text-[10px] text-gray-600 uppercase">Groups</div></div>
                                <div><div class="font-bold text-white text-lg">${formatNumber(p.badgeCount)}</div><div class="text-[10px] text-gray-600 uppercase">Badges</div></div>
                            </div>
                        </div>

                        ${(() => {
                            // --- IDENTITY / ALT PANEL ---
                            if (!app.user || !app.profile.id) return '';
                            
                            console.log("Rendering identity panel...");
                            console.log("app.identities:", app.identities);
                            console.log("Current profile ID:", app.profile.id);
                            const alts = app.identities.filter(i => !(i.platform === 'roblox' && String(i.platform_id) === String(app.profile.id)));
                            console.log("Filtered alts:", alts);
                            const altsToLoad = alts;
                            
                            let identityPanel = `
                                <div class="min-panel p-5 mt-6 border-l-2 border-gray-600 bg-[#0e0e11]">
                                    <div class="flex justify-between items-center mb-3">
                                         <h3 class="text-sm font-bold text-white uppercase flex items-center gap-2">
                                             <i class="fas fa-link text-gray-500"></i> Linked Accounts
                                         </h3>
                                         <button onclick="toggleModal('modal-add-link')" class="text-xs text-gray-400 hover:text-white transition-colors border border-gray-700 px-2 py-0.5 rounded hover:bg-gray-800"><i class="fas fa-plus mr-1"></i>Add</button>
                                    </div>
                                    
                                    ${alts.length > 0 ? `
                                        <div class="space-y-2 max-h-60 overflow-y-auto custom-scroll pr-1">
                                            ${alts.map(alt => {
                                                const confColor = alt.confidence === 'CERTAIN' ? 'text-green-400 border-green-900 bg-green-900/10' : alt.confidence === 'LIKELY' ? 'text-yellow-400 border-yellow-900 bg-yellow-900/10' : 'text-gray-400 border-gray-800';
                                                // Keep ID as string to avoid floating point precision loss with large Discord IDs
                                                const cleanId = String(alt.platform_id).trim();
                                                const imgId = `linked-img-${alt.platform}-${cleanId}`;
                                                const nameId = `linked-name-${alt.platform}-${cleanId}`;
                                                const profileLink = alt.platform === 'roblox' ? `https://www.roblox.com/users/${cleanId}/profile` : '#';
                                                const copyAction = alt.platform === 'discord' ? `onclick="navigator.clipboard.writeText('${cleanId}')"` : '';
                                                
                                                const platformIcon = alt.platform === 'discord' ? 'fab fa-discord' : alt.platform === 'roblox' ? 'fas fa-user' : 'fas fa-link';
                                                const platformColor = alt.platform === 'discord' ? 'text-[#5865F2]' : 'text-gray-500';
                                                
                                                const cardId = `link-card-${alt.platform}-${cleanId}`;
                                                return `
                                                <div id="${cardId}" class="linked-account-card border border-[#333] bg-[#050505] rounded transition-colors" onclick="toggleLinkCard('${cardId}', event)">
                                                    <div class="flex items-center justify-between p-2">
                                                        <div class="flex items-center gap-3 min-w-0 flex-1">
                                                            <div class="relative">
                                                                <img id="${imgId}" src="https://placehold.co/40x40/111/444?text=..." class="w-8 h-8 rounded bg-[#111] border border-[#333] object-cover flex-shrink-0">
                                                                <i class="${platformIcon} ${platformColor} absolute -bottom-0.5 -right-0.5 text-[10px] bg-black rounded-full p-0.5 border border-[#333]"></i>
                                                            </div>
                                                            <div class="min-w-0 flex-1">
                                                                <div id="${nameId}" class="text-xs font-bold text-gray-200 truncate">Loading...</div>
                                                                <div class="flex items-center gap-1.5">
                                                                    <div class="text-[9px] text-gray-500 uppercase font-bold tracking-wider">${alt.platform}</div>
                                                                    <div class="w-0.5 h-0.5 bg-gray-700 rounded-full"></div>
                                                                    <a href="${profileLink}" target="_blank" ${copyAction} class="text-[9px] text-gray-600 font-mono hover:text-gray-400 transition-colors" title="${cleanId}" onclick="event.stopPropagation()">${cleanId}</a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            <div class="text-[9px] font-bold px-1.5 py-0.5 rounded border ${confColor}">${alt.confidence}</div>
                                                            <i class="fas fa-chevron-down text-gray-500 text-xs expand-indicator"></i>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="linked-account-details px-2 pb-2">
                                                        <div class="border-t border-[#222] pt-3 space-y-2">
                                                            <div class="grid grid-cols-2 gap-2 text-xs">
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-500">Confidence:</span>
                                                                    <span class="font-bold ${confColor.split(' ')[0]}">${alt.confidence}</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-500">Platform:</span>
                                                                    <span class="text-white uppercase">${alt.platform}</span>
                                                                </div>
                                                            </div>
                                                            <div class="flex items-center justify-between pt-2">
                                                                <a href="${profileLink}" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 transition-colors" onclick="event.stopPropagation()">
                                                                    <i class="fas fa-external-link-alt mr-1"></i>View Profile
                                                                </a>
                                                                <button onclick="confirmDeleteLink('${alt.platform}', '${cleanId}'); event.stopPropagation();" class="text-xs text-red-500 hover:text-red-400 transition-colors px-2 py-1 border border-red-900/30 rounded hover:bg-red-900/10">
                                                                    <i class="fas fa-unlink mr-1"></i>Remove Link
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    ` : `<div class="text-xs text-gray-500 italic p-2 text-center">No linked identities found.</div>`}
                                </div>
                            `;
                            
                            // Trigger async avatar loading
                            if (altsToLoad.length > 0) {
                                setTimeout(() => hydrateLinkedAccounts(altsToLoad), 100);
                            }
                            
                            return identityPanel;
                        })()}

                        <div class="min-panel p-5 space-y-3 text-sm">
                            <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Metadata</h3>
                            <div class="flex justify-between"><span class="text-gray-500">Created</span><span class="font-mono text-xs text-white">${new Date(p.created).toLocaleDateString()}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Age</span><span class="font-mono text-xs text-white">${p.accountAge} days</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Verified</span><span class="text-white">${p.hasVerifiedBadge ? 'Yes' : 'No'}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Premium</span><span class="text-white">${p.isPremium ? 'Yes' : 'No'}</span></div>
                            <div class="pt-3 border-t border-[#333]">
                                <div class="text-[10px] text-gray-600 uppercase mb-1">Bio</div>
                                <div class="text-xs text-gray-400 italic break-words">${p.description || "No description."}</div>
                                ${risk.decoded ? `<div class="mt-2 bg-yellow-900/20 border border-yellow-900/50 p-2 rounded">${risk.decoded}</div>` : ''}
                            </div>
                        </div>

                        <div class="min-panel p-5">
                            <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Disciplinary Record</h3>
                            ${(banHistory.length) ?
                    `<div class="space-y-2 max-h-40 overflow-y-auto custom-scroll pr-1">
                                    ${banHistory.map(b => `
                                        <div class="border border-[#333] p-2 bg-[#111] rounded text-xs ${b.type === 'EXPLOIT' ? 'border-l-2 border-l-purple-500' : b.type === 'JUSTICE' ? 'border-l-2 border-l-blue-500' : 'border-l-2 border-l-red-500'}">
                                            <div class="font-bold text-white flex justify-between">
                                                <span class="truncate pr-2" title="${b.Reason}">${b.Reason}</span>
                                                <span class="text-[10px] px-1 ${b.type === 'JUSTICE' ? 'bg-blue-900 text-blue-200' : 'bg-red-900 text-red-200'} rounded whitespace-nowrap">${b.type}</span>
                                            </div>
                                            <div class="text-gray-500 mt-1 flex justify-between"><span>${new Date(b.Date).toLocaleDateString()}</span><span>By: ${b.Moderator}</span></div>
                                            
                                            ${b.details ? `
                                                <div class="mt-2 pt-2 border-t border-[#333] space-y-2">
                                                    ${b.details.strike ? `<div class="text-yellow-500 font-mono flex items-center gap-1"><i class="fas fa-bolt text-[10px]"></i> Strike ${b.details.strike}</div>` : ''}
                                                    ${b.details.evidence && b.details.evidence.length > 0 ? `
                                                        <div class="flex flex-wrap gap-1">
                                                            ${b.details.evidence.map((ev, i) => {
                        const link = ev.startsWith('http') ? ev : `https://archive.clanware.org/?uuid=${ev}`;
                        return `<a href="${link}" target="_blank" class="px-2 py-0.5 bg-[#222] hover:bg-[#333] hover:text-white rounded text-[9px] text-blue-400 border border-[#333] transition-colors"><i class="fas fa-link mr-1"></i>Evidence ${i + 1}</a>`;
                    }).join('')}
                                                        </div>
                                                    ` : ''}
                                                    ${(b.details.alts?.length || b.details.account_sharing?.length) ? `
                                                        <div class="bg-black/30 p-1.5 rounded border border-[#222]">
                                                            <div class="text-[9px] text-gray-600 uppercase font-bold mb-1">Linked Accounts (Justice)</div>
                                                            <div class="space-y-1">
                                                                ${[...(b.details.alts || []), ...(b.details.account_sharing || [])].map(a =>
                        `<div class="flex items-center gap-2 text-[10px] text-gray-400">
                                                                        <i class="fas fa-network-wired text-[8px] text-gray-600"></i> 
                                                                        <span class="font-mono text-gray-300">${a.roblox_username || 'Unknown'}</span>
                                                                        <span class="text-[9px] opacity-50">${a.roblox_id}</span>
                                                                    </div>`
                    ).join('')}
                                                            </div>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>`
                    : `<div class="text-gray-600 text-xs italic">Clean record on file.</div>`
                }
                        </div>
                    </div>

                    <div class="lg:col-span-2 space-y-6">
                        <div class="min-panel p-6 border-l-2 ${rBorder}">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-lg font-bold text-white">Threat Assessment</h3>
                                    <div class="text-xs font-mono mt-1 text-gray-500 uppercase tracking-widest ${rColor}">${risk.rating} RISK // SCORE: ${risk.score}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-4xl font-black ${rColor}">${risk.score}</div>
                                    ${app.rotector && app.rotector.flagType > 0 ? `<div class="text-[9px] text-gray-500 uppercase font-mono mt-1">AI Confidence: ${(app.rotector.confidence * 100).toFixed(0)}%</div>` : ''}
                                </div>
                            </div>
                            <div class="w-full bg-[#222] h-1.5 rounded-full overflow-hidden mb-6"><div class="risk-bar-fill ${risk.rating === 'Unsafe' ? 'bg-red-600' : risk.rating === 'Caution' ? 'bg-yellow-500' : 'bg-green-500'}" style="width: ${risk.score}%"></div></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                ${risk.reasons.negative.map(r => `<div class="border border-[#333] bg-red-900/5 p-2 rounded flex items-center justify-between"><div class="flex items-center gap-2 overflow-hidden"><div class="w-6 h-6 rounded-full bg-red-900/20 text-red-500 flex items-center justify-center text-[10px] flex-shrink-0"><i class="fas ${r.icon}"></i></div><span class="text-xs text-gray-300 truncate" title="${r.text}">${r.text}</span></div><span class="text-xs font-mono text-red-500 font-bold ml-2">${r.weight}</span></div>`).join('')}
                                ${risk.reasons.positive.map(r => `<div class="border border-[#333] bg-green-900/5 p-2 rounded flex items-center justify-between"><div class="flex items-center gap-2 overflow-hidden"><div class="w-6 h-6 rounded-full bg-green-900/20 text-green-500 flex items-center justify-center text-[10px] flex-shrink-0"><i class="fas ${r.icon}"></i></div><span class="text-xs text-gray-300 truncate" title="${r.text}">${r.text}</span></div><span class="text-xs font-mono text-green-500 font-bold ml-2">+${r.weight}</span></div>`).join('')}
                            </div>
                            ${(app.rotector && app.rotector.reasons && Object.keys(app.rotector.reasons).length > 0) ? `
                                <div class="mt-4 pt-4 border-t border-[#333]">
                                    <div class="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-2"><i class="fas fa-brain text-orange-500"></i> Rotector AI Report</div>
                                    <div class="space-y-3">
                                        ${Object.entries(app.rotector.reasons).map(([name, data]) => {
                    let evidenceHtml = '';
                    if (data.evidence) {
                        const evText = Array.isArray(data.evidence) ? data.evidence.join('\n') : data.evidence;
                        const decodedEv = attemptCrack(evText);
                        evidenceHtml = `
                                                    <div class="bg-[#000] border border-[#222] rounded p-2 text-[10px] font-mono text-gray-500 break-all relative">
                                                        <span class="absolute top-[-8px] left-2 bg-[#000] px-1 text-[8px] uppercase text-gray-600">Evidence</span>
                                                        ${Array.isArray(data.evidence) ? data.evidence.join('<br>') : data.evidence}
                                                    </div>
                                                    ${decodedEv ? `
                                                        <div class="mt-2 bg-yellow-900/10 border border-yellow-900/30 p-2 rounded relative animate-pulse">
                                                            <div class="text-[9px] text-yellow-600 uppercase font-bold mb-1 flex items-center gap-1">
                                                                <i class="fas fa-unlock"></i> Decoded Cipher <span class="opacity-50">(${decodedEv.method})</span>
                                                            </div>
                                                            <div class="text-[10px] text-yellow-500/90 font-mono break-all leading-relaxed">${decodedEv.text}</div>
                                                        </div>
                                                    ` : ''}
                                                `;
                    }
                    return `<div class="bg-[#111] border border-[#333] rounded p-4 relative overflow-hidden">
                                                <div class="absolute left-0 top-0 bottom-0 w-1 bg-orange-600"></div>
                                                <div class="flex justify-between items-start mb-1">
                                                    <span class="text-orange-500 font-bold text-sm">${name} <span class="text-xs opacity-75 ml-1 text-gray-500">(${(data.confidence * 100).toFixed(0)}%)</span></span>
                                                </div>
                                                <p class="text-gray-300 text-xs mb-3 leading-relaxed">${data.message}</p>
                                                ${evidenceHtml}
                                            </div>`;
                }).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${(app.easiData && app.easiData.isHit) ? `
                                <div class="mt-4 pt-4 border-t border-[#333]">
                                    <div class="text-xs font-bold text-red-500 uppercase mb-3 flex items-center gap-2">
                                        <i class="fas fa-biohazard animate-pulse"></i> EASI Database Dossier
                                    </div>
                                    <div class="bg-[#1a0505] border border-red-900/30 rounded p-4 relative shadow-[0_0_15px_rgba(220,38,38,0.1)]">
                                         <div class="absolute left-0 top-0 bottom-0 w-1 bg-red-600"></div>
                                         
                                         <!-- <<< FIX: Contain moderation_note in a black styled box >>> -->
                                         <div class="bg-[#000] border border-[#222] rounded p-3 text-[10px] font-mono text-red-400/90 break-all relative">
                                            <span class="absolute top-[-8px] left-2 bg-[#1a0505] px-1 text-[8px] uppercase text-red-500 font-bold tracking-wider border border-red-900/50 rounded">Moderation Note</span>
                                            ${app.easiData.data.moderation_note || 'No specific details provided.'}
                                         </div>
                                         <!-- <<< END FIX >>> -->

                                    </div>
                                </div>
                            ` : ''}

                        </div>
                        
                        ${discordPanel}

                        ${mococoPanel}

                        ${app.rings.length > 0 ? `
                            <div class="min-panel p-5 border-l-2 border-red-600 bg-red-900/5">
                                <h3 class="text-sm font-bold text-white uppercase mb-3 flex items-center gap-2"><i class="fas fa-link text-red-500"></i> Ring Affiliations</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    ${app.rings.map(r => {
                    const mem = r.members ? r.members.find(m => String(m.userId) === String(p.id)) : null;
                    const role = mem ? mem.role : 'Member';
                    const count = r.members ? r.members.length : 0;
                    const getRoleStyle = (role) => {
                        switch (role) {
                            case 'Leader': return 'bg-red-500 text-white border-red-400';
                            case 'Figurehead': return 'bg-purple-500 text-white border-purple-400';
                            case 'Alt': return 'bg-yellow-500 text-black border-yellow-400';
                            case 'Smurf': return 'bg-blue-500 text-white border-blue-400';
                            case 'Associate': return 'bg-green-500 text-white border-green-400';
                            default: return 'bg-gray-600 text-white border-gray-500';
                        }
                    };
                    const roleStyle = getRoleStyle(role);
                    return `<div class="border border-[#333] bg-[#111] p-3 rounded hover:border-[#555] transition-colors relative group cursor-pointer" onclick="openRingModal('remove')" title="${r.description || ''}"><div class="flex justify-between items-start mb-2"><div class="text-red-300 font-bold text-sm truncate pr-2">${r.name}</div><div class="text-[10px] text-gray-500 flex-shrink-0 bg-[#222] px-1.5 py-0.5 rounded border border-[#333] flex items-center gap-1"><i class="fas fa-users"></i> ${count}</div></div><div class="flex items-center justify-between"><span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded border ${roleStyle} shadow-sm tracking-wider">${role}</span><span class="text-[9px] text-gray-600 font-mono">${r.isActive !== false ? 'ACTIVE' : 'INACTIVE'}</span></div></div>`;
                }).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="min-panel p-5 flex flex-col h-[400px]">
                                <div class="flex justify-between items-center mb-4 border-b border-[#333] pb-2">
                                    <div class="flex items-center gap-2"><h3 class="text-sm font-bold text-white uppercase">Associates</h3><div id="friend-scan-status" class="text-[9px] text-gray-500 font-mono"></div></div>
                                    <div id="friend-stats-display" class="text-[10px] font-mono"><span class="text-gray-600">Waiting...</span></div>
                                </div>
                                <div id="friends-grid-target" class="grid grid-cols-4 gap-2 mb-4 content-start flex-1 overflow-y-auto custom-scroll"></div>
                                <div class="flex justify-between pt-2 border-t border-[#333] items-center">
                                    <button id="f-prev" class="text-xs text-gray-500 hover:text-white px-3 py-2 disabled:opacity-20">Prev</button>
                                    <div id="friend-pager-indicator" class="text-[10px] text-gray-500 px-2"></div>
                                    <button id="f-next" class="text-xs text-gray-500 hover:text-white px-3 py-2 disabled:opacity-20">Next</button>
                                </div>
                            </div>

                            <div class="min-panel p-5 flex flex-col h-[400px]">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-sm font-bold text-white uppercase">Groups</h3><span class="text-xs text-gray-500 font-mono">${app.groups.length} Total</span></div>
                                <div class="space-y-1 overflow-y-auto custom-scroll flex-1 pr-1">
                                    <!-- UPDATED: Added logic to highlight Moco-co detected groups -->
                                    ${app.groups.map(g => `
                                        <div class="flex items-center justify-between p-2 border ${g.isRed ? 'border-red-500 bg-red-900/20' : 'border-transparent hover:border-[#333] hover:bg-[#111]'} rounded transition-colors group">
                                            <div class="flex items-center gap-3 overflow-hidden">
                                                <div class="w-8 h-8 ${g.isRed ? 'bg-red-900/30 text-red-500' : 'bg-[#222] text-gray-600'} rounded flex-shrink-0 flex items-center justify-center">
                                                    <i class="fas ${g.isRed ? 'fa-exclamation-triangle' : 'fa-users'} text-xs"></i>
                                                </div>
                                                <div class="min-w-0">
                                                    <div class="text-xs ${g.isRed ? 'text-red-300 font-bold' : 'text-white font-bold'} truncate">${g.name}</div>
                                                    <div class="text-[10px] ${g.isRed ? 'text-red-400/70' : 'text-gray-500'} truncate">${g.role || 'Member'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${app.groups.length === 0 ? '<div class="text-gray-600 text-xs text-center mt-10">No public groups found.</div>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            initFriendPager();
            batchCheckFriends();
            if (p.isPOI) fetchPOIDetails(p.id);
            
            // Trigger Client-Side Fetch if panel exists
            if (app.mococoData && app.mococoData.groups && app.mococoData.groups.length > 0) {
                loadGroupAnalysis(app.mococoData.groups);
            }
        }

        let fPage = 1;
        const fPer = 12;

        function initFriendPager() {
            fPage = 1;
            updateFriendGrid();
            document.getElementById('f-prev').onclick = () => { fPage--; updateFriendGrid(); };
            document.getElementById('f-next').onclick = () => { fPage++; updateFriendGrid(); };
        }

        function updateFriendGrid() {
            const t = document.getElementById('friends-grid-target');
            if (!t) return;
            t.innerHTML = '';
            const start = (fPage - 1) * fPer;
            const slice = app.friends.slice(start, start + fPer);

            slice.forEach(async f => {
                const isBanned = app.bannedFriends.some(bf => String(bf.id) === String(f.id));
                const safetyData = app.friendSafety.get(String(f.id));
                let borderClass = 'border-transparent';
                let bgClass = 'bg-[#111]';
                let glowEffect = '';
                let statusBadge = '';

                if (isBanned) {
                    borderClass = 'border-red-600';
                    statusBadge = '<div class="absolute top-1 right-1 text-[8px] bg-red-600 text-white px-1.5 py-0.5 font-bold rounded z-10 shadow-sm">BANNED</div>';
                    glowEffect = 'shadow-[0_0_10px_rgba(220,38,38,0.2)]';
                } else if (safetyData) {
                    if (safetyData.flagType === 2) {
                        borderClass = 'border-red-600';
                        bgClass = 'bg-red-950/20';
                        glowEffect = 'shadow-[0_0_10px_rgba(220,38,38,0.1)]';
                        statusBadge = '<div class="absolute top-1 left-1 text-[8px] bg-red-600 text-white px-1.5 py-0.5 font-bold rounded z-10 shadow-sm"><i class="fas fa-exclamation-triangle"></i></div>';
                    } else if (safetyData.flagType === 1 || safetyData.flagType === 5) {
                        borderClass = 'border-yellow-600/50';
                    } else if (safetyData.flagType === 6) {
                        borderClass = 'border-orange-600';
                        glowEffect = 'shadow-[0_0_10px_rgba(234,88,12,0.2)]';
                        statusBadge = '<div class="absolute top-1 left-1 text-[8px] bg-orange-600 text-white px-1.5 py-0.5 font-bold rounded z-10 shadow-sm"><i class="fas fa-history"></i></div>';
                    }
                }

                const div = document.createElement('div');
                div.className = `${bgClass} p-2 rounded text-center cursor-pointer hover:bg-[#222] transition relative group border ${borderClass} ${glowEffect}`;
                div.onclick = () => search(f.name);
                const imgId = `f-img-${f.id}`;
                let initialSrc = 'https://placehold.co/100x100/333/FFF';
                if (IMG_CACHE.has(f.id)) { initialSrc = IMG_CACHE.get(f.id); }
                else if (f.avatarUrl && !f.avatarUrl.includes('placehold.co')) { initialSrc = f.avatarUrl; IMG_CACHE.set(f.id, f.avatarUrl); }

                div.innerHTML = `${statusBadge}<img id="${imgId}" src="${initialSrc}" class="w-full aspect-square bg-black mb-2 rounded-sm object-cover opacity-${isBanned ? 60 : 100}" data-uid="${f.id}"><div class="text-[10px] truncate text-gray-400 font-mono group-hover:text-white" title="${f.displayName || f.name} (@${f.name})">${f.name}</div>`;
                t.appendChild(div);
                if (!IMG_CACHE.has(f.id)) { const url = await getAvatar(f.id, f.name); const imgEl = document.getElementById(imgId); if (imgEl) imgEl.src = url; }
            });
            document.getElementById('friend-pager-indicator').textContent = `Pg ${fPage}/${Math.ceil(app.friends.length / fPer)}`;
            document.getElementById('f-prev').disabled = fPage === 1;
            document.getElementById('f-next').disabled = (start + fPer) >= app.friends.length;
        }

        function formatNumber(num) { return num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "0"; }

        async function submitPoi() {
            const r = document.getElementById('poi-reason').value; if (!r) return;
            const btn = document.getElementById('btn-poi-submit');
            btn.textContent = "Processing..."; btn.disabled = true;
            try {
                await fetch(`${DATA_WORKER}/poi`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${app.token}` }, body: JSON.stringify({ userId: app.profile.id, username: app.profile.name, displayName: app.profile.displayName, reason: r, markedBy: app.user.username, timestamp: new Date().toISOString(), avatarUrl: app.profile.avatarUrl }) });
                closeModals(); search(app.profile.id);
            } catch (e) { alert('Failed to mark POI'); }
            btn.textContent = "Confirm Designation"; btn.disabled = false;
        }
        document.getElementById('btn-poi-submit').onclick = submitPoi;

        async function unmarkPoi() {
            if (!confirm("Remove POI designation?")) return;
            try {
                await fetch(`${DATA_WORKER}/poi/${app.profile.id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${app.token}` } });
                search(app.profile.id);
            } catch (e) { alert('Error unmarking'); }
        }

        let ringActionType = null;
        async function openRingModal(type) {
            ringActionType = type;
            toggleModal('modal-ring-select');
            const list = document.getElementById('ring-list');
            const title = document.getElementById('ring-modal-title');
            title.textContent = type === 'add' ? 'Add To Ring' : 'Remove From Ring';
            list.innerHTML = '<div class="text-gray-500 text-xs text-center py-4">Loading rings...</div>';
            if (app.userRings.length === 0) {
                try {
                    const r = await fetch(`${AUTH_WORKER}/rings`, { headers: { 'Authorization': `Bearer ${app.token}` } });
                    const d = await r.json();
                    app.userRings = d.rings || [];
                } catch (e) { list.innerHTML = 'Error loading rings. Check console.'; return; }
            }
            let displayRings = app.userRings;
            if (type === 'remove') { displayRings = app.userRings.filter(r => app.rings.some(ar => ar.id === r.id)); }
            list.innerHTML = `<button onclick="toggleModal('modal-ring-create'); closeModals();" class="w-full mb-2 p-2 border border-dashed border-[#333] text-gray-500 text-xs hover:border-white hover:text-white transition-colors rounded">+ Add New Ring</button>${displayRings.map(r => `<label class="flex items-center gap-3 p-3 bg-[#111] border border-[#222] rounded cursor-pointer hover:border-[#444]"><input type="radio" name="sel-ring" value="${r.id}" class="accent-white"><div><div class="text-sm font-bold text-white">${r.name}</div><div class="text-[10px] text-gray-500">${r.members?.length || 0} members</div></div></label>`).join('')}`;
        }

        document.getElementById('btn-ring-confirm').onclick = async () => {
            const id = document.querySelector('input[name="sel-ring"]:checked')?.value;
            if (!id) return;
            try {
                const ep = `${AUTH_WORKER}/rings/${id}/members`;
                const method = ringActionType === 'add' ? 'POST' : 'DELETE';
                const body = { members: [{ userId: app.profile.id, username: app.profile.name }] };
                if (ringActionType === 'remove') body.userIds = [app.profile.id];
                await fetch(ep, { method: method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${app.token}` }, body: JSON.stringify(body) });
                closeModals(); search(app.profile.id);
            } catch (e) { alert('Action failed. Check console.'); }
        };

        document.getElementById('btn-ring-create-submit').onclick = async () => {
            const name = document.getElementById('new-ring-name').value;
            const desc = document.getElementById('new-ring-desc').value;
            const add = document.getElementById('new-ring-auto-add').checked;
            if (!name) return;
            try {
                await fetch(`${AUTH_WORKER}/rings`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${app.token}` }, body: JSON.stringify({ name, description: desc, initialMembers: add ? [{ userId: app.profile.id, username: app.profile.name }] : [] }) });
                const r = await fetch(`${AUTH_WORKER}/rings`, { headers: { 'Authorization': `Bearer ${app.token}` } });
                const d = await r.json();
                app.userRings = d.rings;
                closeModals();
                if (add) search(app.profile.id);
            } catch (e) { alert('Create failed. Check console.'); }
        }

        const MORSE_CODE = { '.-': 'A', '-...': 'B', '-.-.': 'C', '-..': 'D', '.': 'E', '..-.': 'F', '--.': 'G', '....': 'H', '..': 'I', '.---': 'J', '-.-': 'K', '.-..': 'L', '--': 'M', '-.': 'N', '---': 'O', '.--.': 'P', '--.-': 'Q', '.-.': 'R', '...': 'S', '-': 'T', '..-': 'U', '...-': 'V', '.--': 'W', '-..-': 'X', '-.--': 'Y', '--..': 'Z', '-----': '0', '.----': '1', '..---': '2', '...--': '3', '....-': '4', '.....': '5', '-....': '6', '--...': '7', '---..': '8', '----.': '9', '/': ' ', '-...-': '=', '.-.-.-': '.', '--..--': ',', '..--..': '?', '.----.': "'", '-.-.--': '!', '-..-.': '/', '-.--.': '(', '-.--.-': ')', '.-...': '&', '---...': ':', '-.-.-.': ';', '-....-': '-', '..--.-': '_', '.-..-.': '"', '...-..-': '$', '.--.-.': '@' };
        function decodeMorse(text) { return text.split('   ').map(word => word.split(' ').map(code => MORSE_CODE[code] || '').join('')).join(' ').trim(); }

        function calculateSafetyScore(profile, friends, rings, bannedFriends, rotector, federatedBans, easiData, mococoData) {
            let score = 50;
            let reasons = { positive: [], negative: [] };
            let decoded = null;
            const text = (profile.description || "").toLowerCase();

            // --- 1. Check Plain Text against BAD_WORDS ---
            const plainBad = BAD_WORDS.find(w => text.includes(w));
            if (plainBad) {
                score -= 40;
                reasons.negative.push({ text: `Profanity/Threat detected (${plainBad})`, weight: -40, icon: "fa-exclamation-circle" });
            }

            // --- 2. Safer Solicitation Check ---
            // Removed 'snap' standalone to fix "snap my router" false positive.
            // Added stricter regex for short slang terms.
            if (
                text.includes('discord') ||
                text.includes('snapchat') ||
                /\b(cord|insta|kik|skype)\b/i.test(text) ||
                /snap\s*(:|@|is|me)/i.test(text) // Only flag 'snap' if followed by a handle indicator
            ) {
                score -= 20;
                reasons.negative.push({ text: "Solicitation keywords detected", weight: -20, icon: "fa-comment-slash" });
            }

            if (text.includes('') && (text.includes('find') || text.includes('add') || text.includes('me'))) {
                score -= 20;
                reasons.negative.push({ text: "Symbolic solicitation () detected", weight: -20, icon: "fa-icons" });
            }
            if (text.includes('mdni')) {
                score -= 50;
                reasons.negative.push({ text: "Restricted Interaction (MDNI) Marker", weight: -50, icon: "fa-ban" });
            }

            // --- 3. Decryption Engine Check ---
            const cracked = attemptCrack(profile.description);
            if (cracked) {
                // Determine Badge Style based on Confidence
                let badgeClass = "bg-gray-800 text-gray-500 border-gray-700";
                if (cracked.confidence === "HIGH") badgeClass = "bg-green-900/20 text-green-500 border-green-900";
                else if (cracked.confidence === "POSSIBLE") badgeClass = "bg-yellow-900/20 text-yellow-500 border-yellow-900";

                // Logic: Obfuscation is always suspicious, but explicit content is dangerous.
                if (cracked.hasThreat) {
                    score -= 60;
                    reasons.negative.push({ text: `Encoded explicit text (${cracked.method})`, weight: -60, icon: "fa-user-secret" });
                } else {
                    score -= 15;
                    reasons.negative.push({ text: `Obfuscated text detected (${cracked.method})`, weight: -15, icon: "fa-low-vision" });
                }

                decoded = `
                    <div class="text-[10px] text-yellow-600 uppercase font-bold mb-1 flex items-center justify-between">
                        <div><i class="fas fa-unlock mr-1"></i>Decoded (${cracked.method})</div>
                        <span class="text-[8px] border px-1.5 py-0.5 rounded ${badgeClass}">${cracked.confidence} MATCH</span>
                    </div>
                    <div class="text-xs text-yellow-500/80 font-mono select-text">${escapeHtml(cracked.text)}</div>
                `;
            }

            if (/[.-]{1,5}(\s+[.-]{1,5})+/.test(profile.description)) {
                const morseMatches = profile.description.match(/[.-]{1,5}(\s+[.-]{1,5})+/g);
                if (morseMatches) {
                    const decodedMorse = morseMatches.map(m => decodeMorse(m)).join(' ');
                    if (decodedMorse.length > 3) { score -= 30; reasons.negative.push({ text: "Morse Code Detected", weight: -30, icon: "fa-code" }); decoded = `[MORSE]: ${decodedMorse}`; }
                }
            }

            const age = profile.accountAge || 0;
            if (age < 30) { score -= 30; reasons.negative.push({ text: "Account < 30 days old", weight: -30, icon: "fa-baby" }); }
            else if (age > 365 * 2) { score += 20; reasons.positive.push({ text: "Veteran Account (2+ Years)", weight: 20, icon: "fa-star" }); }

            if (profile.isBanned) { score -= 80; reasons.negative.push({ text: "Active Saikou Ban", weight: -80, icon: "fa-ban" }); }
            if (bannedFriends.length > 0) { const pen = Math.min(40, bannedFriends.length * 10); score -= pen; reasons.negative.push({ text: `Linked to ${bannedFriends.length} banned user(s)`, weight: -pen, icon: "fa-users-slash" }); }
            if (rings && rings.length > 0) { score -= 50; reasons.negative.push({ text: `Member of ${rings.length} Exploiter Ring(s)`, weight: -50, icon: "fa-link" }); }
            if (profile.isPOI) { score -= 50; reasons.negative.push({ text: "Designated Person of Interest", weight: -50, icon: "fa-exclamation-triangle" }); }

            const sdisMember = profile.groups && profile.groups.find(g => String(g.id) === SDIS_GROUP_ID);
            if (sdisMember) {
                score += 25;
                reasons.positive.push({ text: "SDIS Intelligence Agent", weight: 25, icon: "fa-user-secret" });
            }

            if (federatedBans && federatedBans.length > 0) {
                const justiceRecords = federatedBans.filter(b => b.isJustice);
                if (justiceRecords.length > 0) {
                    score -= 20;
                    reasons.negative.push({ text: `${justiceRecords.length} Clanware Justice Record(s)`, weight: -90, icon: "fa-gavel" });
                }

                const otherRecords = federatedBans.filter(b => !b.isJustice);
                if (otherRecords.length > 0) {
                    const fedPenalty = otherRecords.length * 40;
                    score -= fedPenalty;
                    reasons.negative.push({ text: `Found in ${otherRecords.length} Federated Ban List(s)`, weight: -fedPenalty, icon: "fa-globe-americas" });
                }
            }

            if (rotector) {
                if (rotector.flagType === 2) { score -= 60; reasons.negative.push({ text: "Rotector AI: Unsafe", weight: -60, icon: "fa-robot" }); }
                else if (rotector.flagType === 5 || rotector.flagType === 6) { score -= 20; reasons.negative.push({ text: "Rotector AI: Flagged Pattern", weight: -20, icon: "fa-robot" }); }
                else if (rotector.flagType === 0) { score += 5; reasons.positive.push({ text: "Rotector AI: Clean Analysis", weight: 5, icon: "fa-shield-virus" }); }
            }

            // NEW: EASI Detection Check
            if (easiData && easiData.isHit) {
                score -= 80;
                reasons.negative.push({
                    text: "EASI Database: Confirmed ERP/Predatory Markers",
                    weight: -80,
                    icon: "fa-biohazard"
                });
            }

            // NEW: Moco-co Intelligence Logic
            // FIX: Calculate count regardless of auth status (use array length if groups exist, otherwise use pre-calculated count)
            if (mococoData) {
                let mCount = 0;
                if (mococoData.groups && Array.isArray(mococoData.groups)) {
                    mCount = mococoData.groups.length;
                } else if (mococoData.groupCount) {
                    mCount = mococoData.groupCount;
                }

                if (mCount > 0) {
                    const penalty = Math.min(60, mCount * 10);
                    score -= penalty;
                    reasons.negative.push({
                        text: `Moco-co: ${mCount} unsafe group affiliations`,
                        weight: -penalty,
                        icon: "fa-layer-group"
                    });
                }
            }

            if (profile.hasVerifiedBadge) { score += 15; reasons.positive.push({ text: "Verified Badge", weight: 15, icon: "fa-check-circle" }); }
            if (profile.isPremium) { score += 10; reasons.positive.push({ text: "Premium Subscriber", weight: 10, icon: "fa-gem" }); }

            score = Math.max(0, Math.min(100, score));
            let rating = "Safe";
            if (score < 40) rating = "Unsafe"; else if (score < 70) rating = "Caution";
            return { score, rating, reasons, decoded };
        }

        initAuth();
        document.getElementById('search-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') search(); });
        document.getElementById('search-btn').onclick = () => search();
        document.getElementById('btn-verify-link').onclick = verifyLinkSubject;
        document.getElementById('link-id').addEventListener('keydown', (e) => { if (e.key === 'Enter') verifyLinkSubject(); });
        document.getElementById('btn-submit-link').onclick = submitLink;
        document.getElementById('btn-delete-link-confirm').onclick = deleteLink;
        document.getElementById('btn-merge-confirm').onclick = async () => {
            if (!app.pendingMerge) return;
            
            const btn = document.getElementById('btn-merge-confirm');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Merging...';
            btn.disabled = true;
            
            try {
                const mergeRes = await fetch(`${LINKER_WORKER}/merge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${app.token}` },
                    body: JSON.stringify({
                        sourceProfileId: app.pendingMerge.existingProfileId,
                        targetProfileId: app.pendingMerge.targetProfileId,
                        keepTarget: true
                    })
                });
                
                if (!mergeRes.ok) {
                    const mergeErr = await mergeRes.json();
                    throw new Error(`Merge failed: ${mergeErr.error || 'Unknown error'}`);
                }
                
                const mergeData = await mergeRes.json();
                console.log("Merge successful:", mergeData);
                
                // Update local state with merged identities
                app.identities = mergeData.identities || [];
                
                // Clear cache and refresh
                app.cache.delete(String(app.profile.id));
                
                closeModals();
                resetVerify();
                document.getElementById('link-id').value = '';
                app.pendingMerge = null;
                
                sendNotification('Profiles Merged', `Successfully merged ${mergeData.total_identities} identities into this profile.`);
                
                // Refresh to show all merged identities
                search(app.profile.id);
                
            } catch (e) {
                alert(`Error: ${e.message}`);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        window.openRingModal = openRingModal;
        window.unmarkPoi = unmarkPoi;
        window.search = search;
        window.toggleModal = toggleModal;
        window.resetVerify = resetVerify;

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('lookup')) search(urlParams.get('lookup'));

    </script>
</body>

</html>